<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="C++ Lambda Story"><meta name=author content=nolongerwait><link href=https://nolongerwait.github.io/cpp_lambda_story_chinese_edition/Chapter2/ rel=canonical><link rel=icon href=../assets/1200px-ISO_C++_Logo.svg.png><meta name=generator content="mkdocs-1.5.3, mkdocs-material-8.2.16"><title>Lambda in C++11 - C++ Lambda Story</title><link rel=stylesheet href=../assets/stylesheets/main.1c3799f8.min.css><link rel=stylesheet href=../assets/stylesheets/palette.cc9b2e1e.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style><link rel=stylesheet href=../assets/stylesheets/extra.9add2662.min.css><script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=light-blue data-md-color-accent=deep-purple> <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#二lambda-in-c11 class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=.. title="C++ Lambda Story" class="md-header__button md-logo" aria-label="C++ Lambda Story" data-md-component=logo> <img src=../assets/1200px-ISO_C++_Logo.svg.png alt=logo> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> C++ Lambda Story </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> Lambda in C++11 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=light-blue data-md-color-accent=deep-purple aria-label="Switch to dark mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_2 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=dracula data-md-color-primary=deep-purple data-md-color-accent=deep-purple aria-label="Switch to light mode" type=radio name=__palette id=__palette_2> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg> </label> </form> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=查找> <a href=javascript:void(0) class="md-search__icon md-icon" aria-label=分享 data-clipboard data-clipboard-text data-md-component=search-share tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7 0-.24-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91 1.61 0 2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08Z"/></svg> </a> <button type=reset class="md-search__icon md-icon" aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> <div class=md-search__suggest data-md-component=search-suggest></div> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/nolongerwait/cpp_lambda_story_chinese_edition title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> cpp-lambda-story-chinese-edition </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--integrated" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="C++ Lambda Story" class="md-nav__button md-logo" aria-label="C++ Lambda Story" data-md-component=logo> <img src=../assets/1200px-ISO_C++_Logo.svg.png alt=logo> </a> C++ Lambda Story </label> <div class=md-nav__source> <a href=https://github.com/nolongerwait/cpp_lambda_story_chinese_edition title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </div> <div class=md-source__repository> cpp-lambda-story-chinese-edition </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> Getting Started </a> </li> <li class=md-nav__item> <a href=../Chapter0/ class=md-nav__link> 关于此书 </a> </li> <li class=md-nav__item> <a href=../Chapter1/ class=md-nav__link> Lambda in C++98/03 </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> Lambda in C++11 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> Lambda in C++11 </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#1-lambda-表达式的语法 class=md-nav__link> 1. Lambda 表达式的语法 </a> <nav class=md-nav aria-label="1. Lambda 表达式的语法"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#lambda-表达式的一些例子 class=md-nav__link> Lambda 表达式的一些例子 </a> </li> <li class=md-nav__item> <a href=#lambda-在编译器的展开 class=md-nav__link> Lambda 在编译器的展开 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#2-lambda-表达式的类型 class=md-nav__link> 2. Lambda 表达式的类型 </a> <nav class=md-nav aria-label="2. Lambda 表达式的类型"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#构造还是拷贝 class=md-nav__link> 构造，还是拷贝？ </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#3-调用操作符 class=md-nav__link> 3. 调用操作符 </a> <nav class=md-nav aria-label="3. 调用操作符"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#重载 class=md-nav__link> 重载 </a> </li> <li class=md-nav__item> <a href=#其他修饰符 class=md-nav__link> 其他修饰符 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#4-捕获 class=md-nav__link> 4. 捕获 </a> <nav class=md-nav aria-label="4. 捕获"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#mutable-关键字 class=md-nav__link> mutable 关键字 </a> </li> <li class=md-nav__item> <a href=#调用计数器---捕获变量的一个例子 class=md-nav__link> 调用计数器 - 捕获变量的一个例子 </a> </li> <li class=md-nav__item> <a href=#捕获全局变量 class=md-nav__link> 捕获全局变量 </a> </li> <li class=md-nav__item> <a href=#捕获静态变量 class=md-nav__link> 捕获静态变量 </a> </li> <li class=md-nav__item> <a href=#捕获类成员和-this-指针 class=md-nav__link> 捕获类成员和 this 指针 </a> </li> <li class=md-nav__item> <a href=#只能移动的对象 class=md-nav__link> 只能移动的对象 </a> </li> <li class=md-nav__item> <a href=#保留常量 class=md-nav__link> 保留常量 </a> </li> <li class=md-nav__item> <a href=#捕获参数包 class=md-nav__link> 捕获参数包 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#5-返回类型 class=md-nav__link> 5. 返回类型 </a> <nav class=md-nav aria-label="5. 返回类型"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#尾部返回类型语法 class=md-nav__link> 尾部返回类型语法 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#6-转化为函数指针 class=md-nav__link> 6. 转化为函数指针 </a> <nav class=md-nav aria-label="6. 转化为函数指针"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#一个有趣的例子 class=md-nav__link> 一个有趣的例子 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#7-iife---立即调用函数表达式 class=md-nav__link> 7. IIFE - 立即调用函数表达式 </a> <nav class=md-nav aria-label="7. IIFE - 立即调用函数表达式"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#可读性提示 class=md-nav__link> 可读性提示 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#8-lambda-继承 class=md-nav__link> 8. Lambda 继承 </a> </li> <li class=md-nav__item> <a href=#9-在容器中存储-lambda class=md-nav__link> 9. 在容器中存储 Lambda </a> </li> <li class=md-nav__item> <a href=#10-总结 class=md-nav__link> 10. 总结 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Chapter3/ class=md-nav__link> Lambda in C++14 </a> </li> <li class=md-nav__item> <a href=../Chapter4/ class=md-nav__link> Lambda in C++17 </a> </li> <li class=md-nav__item> <a href=../Chapter5/ class=md-nav__link> Lambda in C++20 </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=二lambda-in-c11>二、Lambda in C++11<a class=headerlink href=#二lambda-in-c11 title="Permanent link"></a></h1> <p>这真是激动人心的时刻。C++ 委员会听取了开发者们的声音，从 C++11 开始，我们终于拥有了 Lambda 表达式。</p> <p>Lambda 很快就成为了现代 C++ 最广为认可和使用的特性。</p> <p>你可以阅读 <a href=https://timsong-cpp.github.io/cppwp/n3337/ >N3337</a> 草案——C++11 的最终草案——中 <a href=https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda>[expr.prim.lambda]</a> 章节中的 Lambda 规范。</p> <p>我认为委员会把 Lambda 加入进来是一个明智的做法，对于 C++ 这个语言本身而言。</p> <p>他们引进了一种新的语法，而编译器会去将其展开为一个未命名的“隐藏”方函数对象。引入 Lambda，对于一种真正的强类型语言，有很多优点（当然也有缺点），同时这种特性也更容易去推断代码的意图。</p> <p>在本章节，你可以学习到：</p> <ul> <li>Lambda 的基础语法</li> <li>如何捕获变量</li> <li>如何捕获成员变量</li> <li>Lambda 的返回类型</li> <li>什么是闭包对象</li> <li>Lambda 如何转换为一个函数指针以及用 C 风格的 API 来调用</li> <li>IIFE 是什么</li> <li>如何从 Lambda 表达式继承以及它为什么有用</li> </ul> <h2 id=1-lambda-表达式的语法>1. Lambda 表达式的语法<a class=headerlink href=#1-lambda-表达式的语法 title="Permanent link"></a></h2> <p>下面就是 Lambda 语法的「公式」和说明：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-0-1 name=__codelineno-0-1></a><a href=#__codelineno-0-1><span class=linenos data-linenos=" 1 "></span></a>[] () specifiers exception attr -&gt; ret { /*code; */ }
<a id=__codelineno-0-2 name=__codelineno-0-2></a><a href=#__codelineno-0-2><span class=linenos data-linenos=" 2 "></span></a>^  ^  ^                            ^
<a id=__codelineno-0-3 name=__codelineno-0-3></a><a href=#__codelineno-0-3><span class=linenos data-linenos=" 3 "></span></a>|  |  |                            |
<a id=__codelineno-0-4 name=__codelineno-0-4></a><a href=#__codelineno-0-4><span class=linenos data-linenos=" 4 "></span></a>|  |  |                            可选: 尾部返回类型
<a id=__codelineno-0-5 name=__codelineno-0-5></a><a href=#__codelineno-0-5><span class=linenos data-linenos=" 5 "></span></a>|  |  |
<a id=__codelineno-0-6 name=__codelineno-0-6></a><a href=#__codelineno-0-6><span class=linenos data-linenos=" 6 "></span></a>|  |  可选: 可变、异常说明或者 noexcept 、属性
<a id=__codelineno-0-7 name=__codelineno-0-7></a><a href=#__codelineno-0-7><span class=linenos data-linenos=" 7 "></span></a>|  |
<a id=__codelineno-0-8 name=__codelineno-0-8></a><a href=#__codelineno-0-8><span class=linenos data-linenos=" 8 "></span></a>|  参数列表 (当不添加说明符时可选)
<a id=__codelineno-0-9 name=__codelineno-0-9></a><a href=#__codelineno-0-9><span class=linenos data-linenos=" 9 "></span></a>|
<a id=__codelineno-0-10 name=__codelineno-0-10></a><a href=#__codelineno-0-10><span class=linenos data-linenos="10 "></span></a>Lambda 引入器以及捕获列表(可选)
</code></pre></div> <p>在我们开始学习 Lambda 之前，需要从 C++ 标准中引入一些核心定义：</p> <ul> <li>闭包对象在 <a href=https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda#2>[expr.prim.lambda#2]</a> 中，有如下定义：</li> </ul> <blockquote> <p>对 lambda 表达式进行求值会产生一个 <code>prvalue</code> 类型的临时值。这个临时对象叫做 <strong>闭包对象</strong>。</p> </blockquote> <ul> <li>闭包类型在 <a href=https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda#3>[expr.prim.lambda#3]</a> 中，有如下定义：</li> </ul> <blockquote> <p>lambda 表达式的类型（也是闭包对象的类型）是唯一未命名的“非联合”类型——称为 <strong>闭包类型</strong></p> </blockquote> <h3 id=lambda-表达式的一些例子>Lambda 表达式的一些例子<a class=headerlink href=#lambda-表达式的一些例子 title="Permanent link"></a></h3> <div class=highlight><pre><span></span><code><a id=__codelineno-1-1 name=__codelineno-1-1></a><a href=#__codelineno-1-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// 1. 一个最简单的lambda</span>
<a id=__codelineno-1-2 name=__codelineno-1-2></a><a href=#__codelineno-1-2><span class=linenos data-linenos="2 "></span></a><span class=p>[]{};</span>
</code></pre></div> <p>在第一个例子中，你可以看见一个“最小巧”的 Lambda 表达式。</p> <p>它仅需要 <code>[]</code> 和一个空的函数体 <code>{}</code>。参数列表 <code>()</code> 是可选的，所以在本例中不需要。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-2-1 name=__codelineno-2-1></a><a href=#__codelineno-2-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// 2. 带有两个参数的lambda</span>
<a id=__codelineno-2-2 name=__codelineno-2-2></a><a href=#__codelineno-2-2><span class=linenos data-linenos="2 "></span></a><span class=p>[](</span><span class=kt>float</span><span class=w> </span><span class=n>f</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>){</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>f</span><span class=p>;};</span>
<a id=__codelineno-2-3 name=__codelineno-2-3></a><a href=#__codelineno-2-3><span class=linenos data-linenos="3 "></span></a><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>){</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>b</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>在第二个例子中，你可以看到参数在 <code>()</code> 部分被传入进去，就和常规函数一样。返回类型是不需要的，因为编译器会自动推断它。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-3-1 name=__codelineno-3-1></a><a href=#__codelineno-3-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// 3. 带有尾返回类型的lambda</span>
<a id=__codelineno-3-2 name=__codelineno-3-2></a><a href=#__codelineno-3-2><span class=linenos data-linenos="2 "></span></a><span class=p>[](</span><span class=n>MyClass</span><span class=w> </span><span class=n>t</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>t</span><span class=p>.</span><span class=n>compute</span><span class=p>();</span><span class=w> </span><span class=n>print</span><span class=p>(</span><span class=n>a</span><span class=p>);</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>在第三个例子中，我们显示地定义了返回类型。</p> <p>从 C++11 开始，这个尾部返回类型其实和常规函数的声明方式是一样的。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-4-1 name=__codelineno-4-1></a><a href=#__codelineno-4-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// 4. 带有额外描述符的lambda</span>
<a id=__codelineno-4-2 name=__codelineno-4-2></a><a href=#__codelineno-4-2><span class=linenos data-linenos="2 "></span></a><span class=p>[</span><span class=n>x</span><span class=p>](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=k>mutable</span><span class=p>{</span><span class=w> </span><span class=o>++</span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>b</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
<a id=__codelineno-4-3 name=__codelineno-4-3></a><a href=#__codelineno-4-3><span class=linenos data-linenos="3 "></span></a><span class=p>[](</span><span class=kt>float</span><span class=w> </span><span class=n>param</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>param</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>param</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
<a id=__codelineno-4-4 name=__codelineno-4-4></a><a href=#__codelineno-4-4><span class=linenos data-linenos="4 "></span></a><span class=p>[</span><span class=n>x</span><span class=p>](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=k>noexcept</span><span class=p>{</span><span class=w> </span><span class=o>++</span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>b</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>第四个例子展示了在 lambda 表达式的函数体前，你可以添加额外的描述符。</p> <p>如上代码，我们使用 <code>mutable</code>（这样我们就可以改变捕获的变量）也可以是 <code>noexcept</code>。</p> <p>第三个 lambda 表达式同时使用了 <code>mutable</code> 和 <code>noexcept</code>，请注意顺序（当书写为 <code>noexcept mutable</code> 时，无法编译通过）。</p> <p>虽然（）部分是可选的，但是如果你想要应用 <code>mutable</code> 或者 <code>noexcept</code>，那么 <code>()</code> 则必须在表达式书写。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-5-1 name=__codelineno-5-1></a><a href=#__codelineno-5-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// 5. 可选()的lambda</span>
<a id=__codelineno-5-2 name=__codelineno-5-2></a><a href=#__codelineno-5-2><span class=linenos data-linenos="2 "></span></a><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=p>};</span><span class=w> </span><span class=c1>// 正确，无需()</span>
<a id=__codelineno-5-3 name=__codelineno-5-3></a><a href=#__codelineno-5-3><span class=linenos data-linenos="3 "></span></a><span class=p>[</span><span class=n>x</span><span class=p>]</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>++</span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=p>};</span><span class=w>    </span><span class=c1>// 编译失败</span>
<a id=__codelineno-5-4 name=__codelineno-5-4></a><a href=#__codelineno-5-4><span class=linenos data-linenos="4 "></span></a><span class=p>[</span><span class=n>x</span><span class=p>]()</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>++</span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=p>};</span><span class=w>  </span><span class=c1>// 正确，mutable前需要()</span>
<a id=__codelineno-5-5 name=__codelineno-5-5></a><a href=#__codelineno-5-5><span class=linenos data-linenos="5 "></span></a><span class=p>[]</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{};</span><span class=w>          </span><span class=c1>// 编译失败</span>
<a id=__codelineno-5-6 name=__codelineno-5-6></a><a href=#__codelineno-5-6><span class=linenos data-linenos="6 "></span></a><span class=p>[]()</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{};</span><span class=w>        </span><span class=c1>// 正确</span>
</code></pre></div> <p>同样的模式也可以在其他描述符中被应用在 lambda 中，像 C++17 的 <code>constexpr</code> 和 C++20 中的 <code>consteval</code>。</p> <h4 id=属性>属性<a class=headerlink href=#属性 title="Permanent link"></a></h4> <p>Lambda 语法也允许使用以下形式引入的属性：<code>[[attr_name]]</code>。</p> <p>然而，如果你试图在 lambda 应用一个属性，那么这个属性是被应用在调用操作符的类型上，而不是操作符本身。</p> <p>这就是为什么现在（甚至在 C++20）中都没有对 lambda 真正有意义的属性存在。</p> <p>大多数编译器甚至会报错。如果我们使用 C++17 的属性并尝试应用在 Lambda 表达式中：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-6-1 name=__codelineno-6-1></a><a href=#__codelineno-6-1><span class=linenos data-linenos="1 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>myLambda</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>)[[</span><span class=n>nodiscard</span><span class=p>]]{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>使用 <a href=https://wandbox.org/permlink/3zfzL1NNpPXXgLOx>Clang</a> 编译，就会产生如下的编译错误：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-7-1 name=__codelineno-7-1></a><a href=#__codelineno-7-1><span class=linenos data-linenos="1 "></span></a>error: &#39;nodiscard&#39; attribute cannot be applied to types
</code></pre></div> <h3 id=lambda-在编译器的展开>Lambda 在编译器的展开<a class=headerlink href=#lambda-在编译器的展开 title="Permanent link"></a></h3> <p>总结一下，这儿有一个基础的代码用例来展示下编写 Lambda 表达式并应用在 <code>std::for_each</code> 中去。</p> <p>作为对比，我们也编写了一个相应功能的仿函数类型：</p> <blockquote> <p>代码 2-1 <a href=https://wandbox.org/permlink/XXR02LXYAngHF5dt>Lambda 表达式和对应的仿函数</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-8-1 name=__codelineno-8-1></a><a href=#__codelineno-8-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;algorithm&gt;</span>
<a id=__codelineno-8-2 name=__codelineno-8-2></a><a href=#__codelineno-8-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-8-3 name=__codelineno-8-3></a><a href=#__codelineno-8-3><span class=linenos data-linenos=" 3 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
<a id=__codelineno-8-4 name=__codelineno-8-4></a><a href=#__codelineno-8-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-8-5 name=__codelineno-8-5></a><a href=#__codelineno-8-5><span class=linenos data-linenos=" 5 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-6 name=__codelineno-8-6></a><a href=#__codelineno-8-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-7 name=__codelineno-8-7></a><a href=#__codelineno-8-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>        </span><span class=kt>void</span><span class=w> </span><span class=k>operator</span><span class=p>()(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-8 name=__codelineno-8-8></a><a href=#__codelineno-8-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-8-9 name=__codelineno-8-9></a><a href=#__codelineno-8-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-8-10 name=__codelineno-8-10></a><a href=#__codelineno-8-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>someInstance</span><span class=p>;</span>
<a id=__codelineno-8-11 name=__codelineno-8-11></a><a href=#__codelineno-8-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-8-12 name=__codelineno-8-12></a><a href=#__codelineno-8-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>v</span><span class=p>{</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>};</span>
<a id=__codelineno-8-13 name=__codelineno-8-13></a><a href=#__codelineno-8-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>for_each</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>cbegin</span><span class=p>(),</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>cend</span><span class=p>(),</span><span class=w> </span><span class=n>someInstance</span><span class=p>);</span>
<a id=__codelineno-8-14 name=__codelineno-8-14></a><a href=#__codelineno-8-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>for_each</span><span class=p>(</span><span class=n>v</span><span class=p>.</span><span class=n>cbegin</span><span class=p>(),</span><span class=w> </span><span class=n>v</span><span class=p>.</span><span class=n>cend</span><span class=p>(),</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-8-15 name=__codelineno-8-15></a><a href=#__codelineno-8-15><span class=linenos data-linenos="15 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-8-16 name=__codelineno-8-16></a><a href=#__codelineno-8-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=p>});</span>
<a id=__codelineno-8-17 name=__codelineno-8-17></a><a href=#__codelineno-8-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <p>对于这个例子，编译器会将 Lambda 表达式</p> <div class=highlight><pre><span></span><code><a id=__codelineno-9-1 name=__codelineno-9-1></a><a href=#__codelineno-9-1><span class=linenos data-linenos="1 "></span></a><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;n&#39;</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>转化为一个简化格式的匿名仿函数：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-10-1 name=__codelineno-10-1></a><a href=#__codelineno-10-1><span class=linenos data-linenos="1 "></span></a><span class=k>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-2 name=__codelineno-10-2></a><a href=#__codelineno-10-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>operator</span><span class=p>()(</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-10-3 name=__codelineno-10-3></a><a href=#__codelineno-10-3><span class=linenos data-linenos="3 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-10-4 name=__codelineno-10-4></a><a href=#__codelineno-10-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-10-5 name=__codelineno-10-5></a><a href=#__codelineno-10-5><span class=linenos data-linenos="5 "></span></a><span class=p>}</span><span class=w> </span><span class=n>someInstance</span><span class=p>;</span>
</code></pre></div> <p>这种转换或者“展开”的过程，可以在 <a href=https://cppinsights.io/ >C++ Insights</a> 上查看，这是一个可以查看合法 C++ 代码转化为编译器源码视图的在线工具，包括 Lambda 达式的展开以及模板初始化的过程。</p> <p>下一节中，我们会深入研究下 Lambda 表达式的各个部分。</p> <h2 id=2-lambda-表达式的类型>2. Lambda 表达式的类型<a class=headerlink href=#2-lambda-表达式的类型 title="Permanent link"></a></h2> <p>由于编译器会生成给每个 Lambda（闭包类型）生成一个唯一名称，所以没有办法预先“拼写”出它的类型。</p> <p>这就是为什么你需要使用 <code>auto</code> 或者 <code>decltype</code> 关键字来推断类型了。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-11-1 name=__codelineno-11-1></a><a href=#__codelineno-11-1><span class=linenos data-linenos="1 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>myLambda</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kt>double</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=mf>2.0</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>当然，下面这两 lambda 也是一样的。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-12-1 name=__codelineno-12-1></a><a href=#__codelineno-12-1><span class=linenos data-linenos="1 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>firstLam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
<a id=__codelineno-12-2 name=__codelineno-12-2></a><a href=#__codelineno-12-2><span class=linenos data-linenos="2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>secondLam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>这俩 Lambda 拥有完全一样的代码，但是他们的类型是不同的。</p> <p>编译器会推断为两个 Lambda 表达式推断出各自独立的未命名类型。</p> <p>我们可以用下面的代码来证明这个性质：</p> <blockquote> <p>代码 2-2 <a href=https://wandbox.org/permlink/dimC66ghOFL3GF3q>同样的代码，不同的类型</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-13-1 name=__codelineno-13-1></a><a href=#__codelineno-13-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;type_traits&gt;</span>
<a id=__codelineno-13-2 name=__codelineno-13-2></a><a href=#__codelineno-13-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-13-3 name=__codelineno-13-3></a><a href=#__codelineno-13-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-13-4 name=__codelineno-13-4></a><a href=#__codelineno-13-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>oneLam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-13-5 name=__codelineno-13-5></a><a href=#__codelineno-13-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-13-6 name=__codelineno-13-6></a><a href=#__codelineno-13-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-13-7 name=__codelineno-13-7></a><a href=#__codelineno-13-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>twoLam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-13-8 name=__codelineno-13-8></a><a href=#__codelineno-13-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-13-9 name=__codelineno-13-9></a><a href=#__codelineno-13-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-13-10 name=__codelineno-13-10></a><a href=#__codelineno-13-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=k>static_assert</span><span class=p>(</span><span class=o>!</span><span class=n>std</span><span class=o>::</span><span class=n>is_same</span><span class=o>&lt;</span><span class=k>decltype</span><span class=p>(</span><span class=n>oneLam</span><span class=p>),</span><span class=w> </span><span class=k>decltype</span><span class=p>(</span><span class=n>twoLam</span><span class=p>)</span><span class=o>&gt;::</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=s>&quot;must be different!&quot;</span><span class=p>);</span>
<a id=__codelineno-13-11 name=__codelineno-13-11></a><a href=#__codelineno-13-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
</code></pre></div> <p>这个例子可以用来验证两个 Lambda（<code>oneLam</code> 和 <code>twoLam</code>）的闭包类型是否一致。</p> <blockquote> <p>在 C++17，我们可以使用不带消息的 <code>static_assert</code> 和推断类型特征的变量模板辅助函数 <code>is_same_v</code>：</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-14-1 name=__codelineno-14-1></a><a href=#__codelineno-14-1><span class=linenos data-linenos="1 "></span></a><span class=k>static_assert</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>is_same_v</span><span class=o>&lt;</span><span class=kt>double</span><span class=p>,</span><span class=w> </span><span class=k>decltype</span><span class=p>(</span><span class=n>baz</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span><span class=o>&gt;</span><span class=p>);</span>
</code></pre></div> <p>但是，尽管你不知道确切的类型名，你可以将 Lambda 的签名存储在 <code>std::function</code> 中使用。</p> <p>通常来说，如果定义为 <code>auto</code> 的 Lambda 无法解决的，可以通过定义为 <code>std::function</code> 类型来解决。</p> <p>举个例子，之前的 Lambda 有一个 <code>double(int)</code> 的签名（参数为 <code>int</code> 返回 <code>double</code>）。</p> <p>我们可以通过以下方式创建一个 <code>std::function</code> 对象：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-15-1 name=__codelineno-15-1></a><a href=#__codelineno-15-1><span class=linenos data-linenos="1 "></span></a><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>double</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=o>&gt;</span><span class=w> </span><span class=n>myFunc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kt>double</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=mf>2.0</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>a</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p><code>std::function</code> 是一个“笨重”的对象，因为他需要操控全部的可调用对象。</p> <p>为了实现这一点，他需要一套先进的内核机制，比如 <a href=https://zh.wikipedia.org/wiki/%E7%B1%BB%E5%9E%8B%E5%8F%8C%E5%85%B3>类型双关（Type punning）</a> 或者甚至动态内存分配。</p> <p>来试试下面这个例子：</p> <blockquote> <p>代码 2-3 <a href=https://wandbox.org/permlink/bTJHEc4uWAMTteyN><code>std::function</code> 和 <code>auto</code> 类型推断</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-16-1 name=__codelineno-16-1></a><a href=#__codelineno-16-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
<a id=__codelineno-16-2 name=__codelineno-16-2></a><a href=#__codelineno-16-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-16-3 name=__codelineno-16-3></a><a href=#__codelineno-16-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-16-4 name=__codelineno-16-4></a><a href=#__codelineno-16-4><span class=linenos data-linenos=" 4 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-5 name=__codelineno-16-5></a><a href=#__codelineno-16-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>myLambda</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kt>double</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-6 name=__codelineno-16-6></a><a href=#__codelineno-16-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mf>2.0</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>a</span><span class=p>;</span>
<a id=__codelineno-16-7 name=__codelineno-16-7></a><a href=#__codelineno-16-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-16-8 name=__codelineno-16-8></a><a href=#__codelineno-16-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-16-9 name=__codelineno-16-9></a><a href=#__codelineno-16-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>double</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=o>&gt;</span><span class=w> </span><span class=n>myFunc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kt>double</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-16-10 name=__codelineno-16-10></a><a href=#__codelineno-16-10><span class=linenos data-linenos="10 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=mi>2</span><span class=w> </span><span class=mf>.0</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>a</span><span class=p>;</span>
<a id=__codelineno-16-11 name=__codelineno-16-11></a><a href=#__codelineno-16-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-16-12 name=__codelineno-16-12></a><a href=#__codelineno-16-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-16-13 name=__codelineno-16-13></a><a href=#__codelineno-16-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;sizeof(myLambda) is &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>myLambda</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-16-14 name=__codelineno-16-14></a><a href=#__codelineno-16-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;sizeof(myFunc) is &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>myFunc</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-16-15 name=__codelineno-16-15></a><a href=#__codelineno-16-15><span class=linenos data-linenos="15 "></span></a>
<a id=__codelineno-16-16 name=__codelineno-16-16></a><a href=#__codelineno-16-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>myLambda</span><span class=p>(</span><span class=mi>10</span><span class=p>)</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=n>myFunc</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
<a id=__codelineno-16-17 name=__codelineno-16-17></a><a href=#__codelineno-16-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <p>用 GCC 编译并运行，将会输出：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-17-1 name=__codelineno-17-1></a><a href=#__codelineno-17-1><span class=linenos data-linenos="1 "></span></a>sizeof(myLambda) is 1
<a id=__codelineno-17-2 name=__codelineno-17-2></a><a href=#__codelineno-17-2><span class=linenos data-linenos="2 "></span></a>sizeof(myFunc) is 32
</code></pre></div> <p>因为 <code>myLambda</code> 仅仅是一个无状态 Lambda，所以它也是一个没有任何数据成员字段的空类，这也就是为什么它的大小只有 1 字节的原因。</p> <p>而 <code>std::function</code> 版本则占用了 32 字节。</p> <p>所以，一目了然，这就是为什么你应该尽可能使用 <code>auto</code> 类型推断来获取占用内存更少的闭包对象了。</p> <p>当然，我们也不得不去深入讨论 <code>std::function</code> 的使用，因为它不支持只能移动（moveable-only）的闭包对象。</p> <p>我们会在 C++14 章可移动类型一节 来详细介绍这部分内容。</p> <h3 id=构造还是拷贝>构造，还是拷贝？<a class=headerlink href=#构造还是拷贝 title="Permanent link"></a></h3> <p>在 <a href=https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda#19>[expr.prim.lambda#19]</a> 中有一个规则：</p> <blockquote> <p>Lambda 表达式产生的闭包对象是 <strong>删除</strong> 了 <em>默认构造函数</em> 和 <em>拷贝赋值运算符</em> 的。 但是它包含隐式声明的 <strong>拷贝构造函数</strong> 以及 <strong>移动构造函数</strong>。</p> </blockquote> <p>由于这个规则的存在，所以你无法这样编写代码：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-18-1 name=__codelineno-18-1></a><a href=#__codelineno-18-1><span class=linenos data-linenos="1 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>]()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>++</span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=o>++</span><span class=n>y</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
<a id=__codelineno-18-2 name=__codelineno-18-2></a><a href=#__codelineno-18-2><span class=linenos data-linenos="2 "></span></a><span class=k>decltype</span><span class=p>(</span><span class=n>foo</span><span class=p>)</span><span class=w> </span><span class=n>fooCopy</span>
</code></pre></div> <p>GCC 会提示如下错误：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-19-1 name=__codelineno-19-1></a><a href=#__codelineno-19-1><span class=linenos data-linenos="1 "></span></a>error: use of deleted function&#39;main()::&lt;lambda()&gt;::&lt;lambda&gt;()&#39;
<a id=__codelineno-19-2 name=__codelineno-19-2></a><a href=#__codelineno-19-2><span class=linenos data-linenos="2 "></span></a>       decltype(foo) fooCopy;
<a id=__codelineno-19-3 name=__codelineno-19-3></a><a href=#__codelineno-19-3><span class=linenos data-linenos="3 "></span></a>                  ^~~~~~~
<a id=__codelineno-19-4 name=__codelineno-19-4></a><a href=#__codelineno-19-4><span class=linenos data-linenos="4 "></span></a>note:a lambda closure type has a deleted default constructor
</code></pre></div> <p>但是，你可以拷贝 Lambda：</p> <blockquote> <p>代码 2-4 <a href=https://wandbox.org/permlink/F50TYeCwooAWaruV>拷贝 Lambda</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-20-1 name=__codelineno-20-1></a><a href=#__codelineno-20-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;type_traits&gt;</span>
<a id=__codelineno-20-2 name=__codelineno-20-2></a><a href=#__codelineno-20-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-20-3 name=__codelineno-20-3></a><a href=#__codelineno-20-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-20-4 name=__codelineno-20-4></a><a href=#__codelineno-20-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>firstLam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-20-5 name=__codelineno-20-5></a><a href=#__codelineno-20-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-20-6 name=__codelineno-20-6></a><a href=#__codelineno-20-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-20-7 name=__codelineno-20-7></a><a href=#__codelineno-20-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-20-8 name=__codelineno-20-8></a><a href=#__codelineno-20-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>secondLam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>firstLam</span><span class=p>;</span>
<a id=__codelineno-20-9 name=__codelineno-20-9></a><a href=#__codelineno-20-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=k>static_assert</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>is_same</span><span class=o>&lt;</span><span class=k>decltype</span><span class=p>(</span><span class=n>firstLam</span><span class=p>),</span><span class=w> </span><span class=k>decltype</span><span class=p>(</span><span class=n>secondLam</span><span class=p>)</span><span class=o>&gt;::</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=s>&quot;must be the same&quot;</span><span class=p>);</span>
<a id=__codelineno-20-10 name=__codelineno-20-10></a><a href=#__codelineno-20-10><span class=linenos data-linenos="10 "></span></a><span class=p>}</span>
</code></pre></div> <p>如果拷贝了一个 Lambda（实际上发生的是拷贝构造），它的状态也会被拷贝过来。</p> <p>这一点对于捕获对象来说很重要。</p> <p>因为，一个闭包类型会存储捕获的对象作为其成员字段。</p> <p>所以，当进行 Lambda 拷贝时，会拷贝那些数据成员字段。</p> <blockquote> <p>在 C++20 中，无状态 Lambda 会拥有默认的构造器和拷贝赋值。</p> </blockquote> <h2 id=3-调用操作符>3. 调用操作符<a class=headerlink href=#3-调用操作符 title="Permanent link"></a></h2> <p>我们传入 Lambda 中的参数部分，会被“转译”为相应闭包类型的调用操作符的参数。</p> <p>默认情况下，在 C++11 中，他会被“转译”为一个常量内联成员函数。</p> <p>例如</p> <div class=highlight><pre><span></span><code><a id=__codelineno-21-1 name=__codelineno-21-1></a><a href=#__codelineno-21-1><span class=linenos data-linenos="1 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>lam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>double</span><span class=w> </span><span class=n>param</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/*do something*/</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>将被编译器展开为：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-22-1 name=__codelineno-22-1></a><a href=#__codelineno-22-1><span class=linenos data-linenos="1 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>__anonymousLambda</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-22-2 name=__codelineno-22-2></a><a href=#__codelineno-22-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=kr>inline</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>operator</span><span class=p>()(</span><span class=kt>double</span><span class=w> </span><span class=n>param</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/*do something*/</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-22-3 name=__codelineno-22-3></a><a href=#__codelineno-22-3><span class=linenos data-linenos="3 "></span></a><span class=p>};</span>
</code></pre></div> <h3 id=重载>重载<a class=headerlink href=#重载 title="Permanent link"></a></h3> <p>有一件事情值得提一下，那就是当你定义了一个 lambda 时，你不能创建它的任何重载形式来传入不同的参数。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-23-1 name=__codelineno-23-1></a><a href=#__codelineno-23-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// 无法编译</span>
<a id=__codelineno-23-2 name=__codelineno-23-2></a><a href=#__codelineno-23-2><span class=linenos data-linenos="2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>lam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>double</span><span class=w> </span><span class=n>param</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/* do something */</span><span class=w> </span><span class=p>};</span>
<a id=__codelineno-23-3 name=__codelineno-23-3></a><a href=#__codelineno-23-3><span class=linenos data-linenos="3 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>lam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>param</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/* do something */</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>上面的代码将无法通过编译，因为编译器会将他们“转译”为一个仿函数，当然这就意味着无法重新定义一个相同的变量。</p> <p>但是，你可以在一个仿函数中定义两个调用操作符的重载形式，这是允许的：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-24-1 name=__codelineno-24-1></a><a href=#__codelineno-24-1><span class=linenos data-linenos="1 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>MyFunctor</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-24-2 name=__codelineno-24-2></a><a href=#__codelineno-24-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=kr>inline</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>operator</span><span class=p>()(</span><span class=kt>double</span><span class=w> </span><span class=n>param</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/* do something */</span><span class=w> </span><span class=p>};</span>
<a id=__codelineno-24-3 name=__codelineno-24-3></a><a href=#__codelineno-24-3><span class=linenos data-linenos="3 "></span></a><span class=w>    </span><span class=kr>inline</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>operator</span><span class=p>()(</span><span class=kt>int</span><span class=w> </span><span class=n>param</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/* do something */</span><span class=w> </span><span class=p>};</span>
<a id=__codelineno-24-4 name=__codelineno-24-4></a><a href=#__codelineno-24-4><span class=linenos data-linenos="4 "></span></a><span class=p>};</span>
</code></pre></div> <p><code>MyFunctor</code> 现在就可以同时接受 <code>double</code> 和 <code>int</code> 参数了。</p> <p>如果你想在 Lambda 中实现相似的效果，那么你可以看看这部分内容 <a href>Lambda 继承</a></p> <h3 id=其他修饰符>其他修饰符<a class=headerlink href=#其他修饰符 title="Permanent link"></a></h3> <p>我们在 Lambda 语法 一节中简略介绍过这部分主题，但是你并不会被闭包类型调用操作符的默认声明所限制到。</p> <p>在 C++11 中，你可以添加 <code>mutalbe</code> 或者异常描述符。</p> <blockquote> <p>如果可能的话，本书会使用长例子来用 <code>const</code> 标记闭包对象并且使 Lambda 为 <code>noexcept</code>。</p> </blockquote> <p>你可以通过在参数声明后面那部分指定 <code>mutable</code> 或者 <code>noexcept</code> 来使用这些关键字。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-25-1 name=__codelineno-25-1></a><a href=#__codelineno-25-1><span class=linenos data-linenos="1 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>myLambda</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=cm>/* do something */</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>编译器会展开为：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-26-1 name=__codelineno-26-1></a><a href=#__codelineno-26-1><span class=linenos data-linenos="1 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>__anonymousLambda</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-26-2 name=__codelineno-26-2></a><a href=#__codelineno-26-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=kr>inline</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>operator</span><span class=p>()(</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=p>{</span><span class=w> </span><span class=cm>/* do something */</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-26-3 name=__codelineno-26-3></a><a href=#__codelineno-26-3><span class=linenos data-linenos="3 "></span></a><span class=p>};</span>
</code></pre></div> <p>请注意，<code>const</code> 关键字此时会消失，并且调用操作符可以修改 Lambda 的成员变量了。</p> <p>但是，成员变量呢？我们要如何在 Lambda 中声明成员变量？</p> <p>请看下一个章节——关于「捕获」变量。</p> <h2 id=4-捕获>4. 捕获<a class=headerlink href=#4-捕获 title="Permanent link"></a></h2> <p><strong>捕获子句</strong>-<code>[]</code> 操作符绝不仅仅只是 Lambda 的引入符号，同时它还兼顾捕获变量的列表的职能。</p> <p>通过从 Lambda 表达式外部捕获变量，你可以在闭包类型中创建成员变量（非静态成员），然后，在 Lambda 函数体中，你就可以使用它了。</p> <p>我们可以弄一个类似于 C++98/03 章节中 <code>PrintFunctor</code> 的内容，在这个类中，我们添加成员变量 <code>std::string strText</code> 并让他在构造函数中被初始化。</p> <p>拥有一个成员变量可以让我们存储可调用对象的一些状态了。</p> <p>一些有关捕获器的语法：</p> <ul> <li><code>[&amp;]</code> - 引用捕获，自动捕获声明在捕获范围内的生命周期尚未结束的变量。</li> <li><code>[=]</code> - 值捕获（创建拷贝），自动捕获声明在捕获范围内的生命周期尚未结束的变量。</li> <li><code>[x, &amp;y]</code> - <code>x</code> 为值捕获，<code>y</code> 为显式引用捕获。</li> <li><code>[args...]</code> - 捕获一个模板参数包，全部都是值捕获</li> <li><code>[&amp;args...]</code> - 捕获一个模板参数包，全部都是引用捕获</li> </ul> <p>一些例子：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-27-1 name=__codelineno-27-1></a><a href=#__codelineno-27-1><span class=linenos data-linenos=" 1 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>3</span><span class=p>;</span>
<a id=__codelineno-27-2 name=__codelineno-27-2></a><a href=#__codelineno-27-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>l1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-3 name=__codelineno-27-3></a><a href=#__codelineno-27-3><span class=linenos data-linenos=" 3 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>l1</span><span class=p>;</span>
<a id=__codelineno-27-4 name=__codelineno-27-4></a><a href=#__codelineno-27-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>};</span><span class=w>  </span><span class=c1>// 没有捕获</span>
<a id=__codelineno-27-5 name=__codelineno-27-5></a><a href=#__codelineno-27-5><span class=linenos data-linenos=" 5 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>l2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>=</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-6 name=__codelineno-27-6></a><a href=#__codelineno-27-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-27-7 name=__codelineno-27-7></a><a href=#__codelineno-27-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>};</span><span class=w>  </span><span class=c1>// 值捕获（拷贝）</span>
<a id=__codelineno-27-8 name=__codelineno-27-8></a><a href=#__codelineno-27-8><span class=linenos data-linenos=" 8 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>l3</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-9 name=__codelineno-27-9></a><a href=#__codelineno-27-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-27-10 name=__codelineno-27-10></a><a href=#__codelineno-27-10><span class=linenos data-linenos="10 "></span></a><span class=p>};</span><span class=w>  </span><span class=c1>// 引用捕获</span>
<a id=__codelineno-27-11 name=__codelineno-27-11></a><a href=#__codelineno-27-11><span class=linenos data-linenos="11 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>l4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>x</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-12 name=__codelineno-27-12></a><a href=#__codelineno-27-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-27-13 name=__codelineno-27-13></a><a href=#__codelineno-27-13><span class=linenos data-linenos="13 "></span></a><span class=p>};</span><span class=w>  </span><span class=c1>// 仅值捕获x</span>
<a id=__codelineno-27-14 name=__codelineno-27-14></a><a href=#__codelineno-27-14><span class=linenos data-linenos="14 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>lx</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>=</span><span class=w> </span><span class=n>x</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-15 name=__codelineno-27-15></a><a href=#__codelineno-27-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-27-16 name=__codelineno-27-16></a><a href=#__codelineno-27-16><span class=linenos data-linenos="16 "></span></a><span class=p>};</span><span class=w>  </span><span class=c1>// 错误的语法，不需要=来对x显式进行拷贝（值捕获）</span>
<a id=__codelineno-27-17 name=__codelineno-27-17></a><a href=#__codelineno-27-17><span class=linenos data-linenos="17 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>l5</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>y</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-18 name=__codelineno-27-18></a><a href=#__codelineno-27-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-27-19 name=__codelineno-27-19></a><a href=#__codelineno-27-19><span class=linenos data-linenos="19 "></span></a><span class=p>};</span><span class=w>  </span><span class=c1>// 仅引用捕获y</span>
<a id=__codelineno-27-20 name=__codelineno-27-20></a><a href=#__codelineno-27-20><span class=linenos data-linenos="20 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>l6</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-21 name=__codelineno-27-21></a><a href=#__codelineno-27-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-27-22 name=__codelineno-27-22></a><a href=#__codelineno-27-22><span class=linenos data-linenos="22 "></span></a><span class=p>};</span><span class=w>  </span><span class=c1>// 值捕获x，引用捕获y</span>
<a id=__codelineno-27-23 name=__codelineno-27-23></a><a href=#__codelineno-27-23><span class=linenos data-linenos="23 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>l7</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>=</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>x</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-24 name=__codelineno-27-24></a><a href=#__codelineno-27-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-27-25 name=__codelineno-27-25></a><a href=#__codelineno-27-25><span class=linenos data-linenos="25 "></span></a><span class=p>};</span><span class=w>  </span><span class=c1>// 全部都是值捕获，除了x是引用捕获</span>
<a id=__codelineno-27-26 name=__codelineno-27-26></a><a href=#__codelineno-27-26><span class=linenos data-linenos="26 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>l8</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-27-27 name=__codelineno-27-27></a><a href=#__codelineno-27-27><span class=linenos data-linenos="27 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-27-28 name=__codelineno-27-28></a><a href=#__codelineno-27-28><span class=linenos data-linenos="28 "></span></a><span class=p>};</span><span class=w>  </span><span class=c1>// 全都是引用捕获，除了y是值捕获</span>
</code></pre></div> <p>为了理解在捕获变量的过程中发生了什么，让我们一起来思考下面这个例子：</p> <blockquote> <p>代码 2-5 捕获一个变量</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-28-1 name=__codelineno-28-1></a><a href=#__codelineno-28-1><span class=linenos data-linenos="1 "></span></a><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>str</span><span class=p>{</span><span class=s>&quot;Hello World&quot;</span><span class=p>};</span>
<a id=__codelineno-28-2 name=__codelineno-28-2></a><a href=#__codelineno-28-2><span class=linenos data-linenos="2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>str</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-28-3 name=__codelineno-28-3></a><a href=#__codelineno-28-3><span class=linenos data-linenos="3 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-28-4 name=__codelineno-28-4></a><a href=#__codelineno-28-4><span class=linenos data-linenos="4 "></span></a><span class=p>};</span>
<a id=__codelineno-28-5 name=__codelineno-28-5></a><a href=#__codelineno-28-5><span class=linenos data-linenos="5 "></span></a><span class=n>foo</span><span class=p>();</span>
</code></pre></div> <p>上面这个 Lambda，<code>str</code> 被值捕获（构造了一个拷贝）。</p> <p>编译器将自动生成这样的仿函数：</p> <blockquote> <p>代码 2-6 编译器可能生成的仿函数，单变量</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-29-1 name=__codelineno-29-1></a><a href=#__codelineno-29-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>__unnamedLambda</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-29-2 name=__codelineno-29-2></a><a href=#__codelineno-29-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-29-3 name=__codelineno-29-3></a><a href=#__codelineno-29-3><span class=linenos data-linenos=" 3 "></span></a><span class=w>    </span><span class=kr>inline</span><span class=w> </span><span class=cm>/*constexpr */</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=k>operator</span><span class=p>()()</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-29-4 name=__codelineno-29-4></a><a href=#__codelineno-29-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=k>operator</span><span class=o>&lt;&lt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=k>operator</span><span class=o>&lt;&lt;</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=p>,</span><span class=w> </span><span class=n>str</span><span class=p>),</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>);</span>
<a id=__codelineno-29-5 name=__codelineno-29-5></a><a href=#__codelineno-29-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-29-6 name=__codelineno-29-6></a><a href=#__codelineno-29-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-29-7 name=__codelineno-29-7></a><a href=#__codelineno-29-7><span class=linenos data-linenos=" 7 "></span></a><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-29-8 name=__codelineno-29-8></a><a href=#__codelineno-29-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>str</span><span class=p>;</span>
<a id=__codelineno-29-9 name=__codelineno-29-9></a><a href=#__codelineno-29-9><span class=linenos data-linenos=" 9 "></span></a>
<a id=__codelineno-29-10 name=__codelineno-29-10></a><a href=#__codelineno-29-10><span class=linenos data-linenos="10 "></span></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-29-11 name=__codelineno-29-11></a><a href=#__codelineno-29-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=n>__unnamedLambda</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>_str</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>str</span><span class=p>{</span><span class=n>_str</span><span class=p>}</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-29-12 name=__codelineno-29-12></a><a href=#__codelineno-29-12><span class=linenos data-linenos="12 "></span></a><span class=p>};</span>
</code></pre></div> <p>如上述的展开代码，一个变量被传进构造函数中，在 Lambda 声明中被称为“就地”。</p> <p>更准确的定义在 <a href=https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda#21>[expr.prim.lambda#21]</a>：当解析 Lambda 表达式时，通过值捕获的实体将直接初始化在每个对应生成的闭包对象中的非静态成员数据。</p> <p>当然了，上述代码中的构造函数（<code>__unnamedLambda</code>）仅仅是用作演示和解释用途，编译器真正生成的内容会与此有所差别，并且不会暴露给用户。</p> <blockquote> <p>代码 2-7 引用捕获两个变量</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-30-1 name=__codelineno-30-1></a><a href=#__codelineno-30-1><span class=linenos data-linenos="1 "></span></a><span class=kt>int</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-30-2 name=__codelineno-30-2></a><a href=#__codelineno-30-2><span class=linenos data-linenos="2 "></span></a><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-30-3 name=__codelineno-30-3></a><a href=#__codelineno-30-3><span class=linenos data-linenos="3 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>y</span><span class=p>]()</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-30-4 name=__codelineno-30-4></a><a href=#__codelineno-30-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-30-5 name=__codelineno-30-5></a><a href=#__codelineno-30-5><span class=linenos data-linenos="5 "></span></a><span class=w>    </span><span class=o>++</span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-30-6 name=__codelineno-30-6></a><a href=#__codelineno-30-6><span class=linenos data-linenos="6 "></span></a><span class=p>};</span>
<a id=__codelineno-30-7 name=__codelineno-30-7></a><a href=#__codelineno-30-7><span class=linenos data-linenos="7 "></span></a><span class=n>foo</span><span class=p>();</span>
<a id=__codelineno-30-8 name=__codelineno-30-8></a><a href=#__codelineno-30-8><span class=linenos data-linenos="8 "></span></a><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
</code></pre></div> <p>上述代码展开后，可能是：</p> <blockquote> <p>代码 2-8 <a href=https://wandbox.org/permlink/da9ltcv53ECxnoEk>编译器可能生成的仿函数，双变量，引用</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-31-1 name=__codelineno-31-1></a><a href=#__codelineno-31-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>__unnamedLambda</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-31-2 name=__codelineno-31-2></a><a href=#__codelineno-31-2><span class=linenos data-linenos=" 2 "></span></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-31-3 name=__codelineno-31-3></a><a href=#__codelineno-31-3><span class=linenos data-linenos=" 3 "></span></a><span class=w>    </span><span class=kr>inline</span><span class=w> </span><span class=cm>/* constexpr */</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=k>operator</span><span class=p>()()</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-31-4 name=__codelineno-31-4></a><a href=#__codelineno-31-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-31-5 name=__codelineno-31-5></a><a href=#__codelineno-31-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-31-6 name=__codelineno-31-6></a><a href=#__codelineno-31-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-31-7 name=__codelineno-31-7></a><a href=#__codelineno-31-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-31-8 name=__codelineno-31-8></a><a href=#__codelineno-31-8><span class=linenos data-linenos=" 8 "></span></a><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-31-9 name=__codelineno-31-9></a><a href=#__codelineno-31-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=kt>int</span><span class=o>&amp;</span><span class=w> </span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-31-10 name=__codelineno-31-10></a><a href=#__codelineno-31-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=kt>int</span><span class=o>&amp;</span><span class=w> </span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-31-11 name=__codelineno-31-11></a><a href=#__codelineno-31-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-31-12 name=__codelineno-31-12></a><a href=#__codelineno-31-12><span class=linenos data-linenos="12 "></span></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-31-13 name=__codelineno-31-13></a><a href=#__codelineno-31-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=n>__unnamedLambda</span><span class=p>(</span><span class=kt>int</span><span class=o>&amp;</span><span class=w> </span><span class=n>_x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=o>&amp;</span><span class=w> </span><span class=n>_y</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>x</span><span class=p>{</span><span class=n>_x</span><span class=p>},</span><span class=w> </span><span class=n>y</span><span class=p>{</span><span class=n>_y</span><span class=p>}</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-31-14 name=__codelineno-31-14></a><a href=#__codelineno-31-14><span class=linenos data-linenos="14 "></span></a><span class=p>};</span>
</code></pre></div> <p>由于我们是通过引用的方式捕获 <code>x</code> 和 <code>y</code> 的，所以闭包类型中的成员变量也是引用类型的。</p> <blockquote> <p>请注意： 值捕获变量的值是在 Lambda <strong>定义</strong> 时，而不是在 <strong>使用</strong> 时。 但是引用捕获变量的内容是在 Lambda <strong>使用</strong> 时，而不是 <strong>定义</strong> 时。二者是有区别的。</p> </blockquote> <p>虽然指定 <code>[=]</code> 或者 <code>[&amp;]</code> 可能很方便，因为它会自动捕获仍在生命周期内的全部变量，但是，若能指明捕获的变量是哪些，将会更加清晰明确。</p> <p>这样编译器才能警告出哪些非预期的影响（参见 全局变量 和 静态变量）。</p> <p>当然，如果你想要了解更多更详细的内容，可以翻阅 Scott Meyers 所著的《Effective Modern C++》第 31 项——“避免默认捕获模式”的内容。</p> <blockquote> <p>请注意： C++ 闭包不会延长被捕获引用对象的剩余生命周期。请务必确保捕获对象在 Lambda 调用时仍然“存活”。</p> </blockquote> <h3 id=mutable-关键字><code>mutable</code> 关键字<a class=headerlink href=#mutable-关键字 title="Permanent link"></a></h3> <p>通过闭包类型默认调用操作符获取的，都是带有 <code>const</code> 关键字限定的，你无法在 Lambda 表达式内部对他们做出任何修改。</p> <p>如果你希望进行修改的操作，那就需要在参数列表后添加 <code>mutable</code> 关键字。</p> <p>它可以有效的去除闭包类型调用操作符中的 <code>const</code> <code>修饰符。举一个mutable</code> 的简单例子：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-32-1 name=__codelineno-32-1></a><a href=#__codelineno-32-1><span class=linenos data-linenos="1 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-32-2 name=__codelineno-32-2></a><a href=#__codelineno-32-2><span class=linenos data-linenos="2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=p>[</span><span class=n>x</span><span class=p>]()</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>++</span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=p>};</span>
</code></pre></div> <p>它会被展开为：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-33-1 name=__codelineno-33-1></a><a href=#__codelineno-33-1><span class=linenos data-linenos="1 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>__lambda_x1</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-33-2 name=__codelineno-33-2></a><a href=#__codelineno-33-2><span class=linenos data-linenos="2 "></span></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-33-3 name=__codelineno-33-3></a><a href=#__codelineno-33-3><span class=linenos data-linenos="3 "></span></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=k>operator</span><span class=p>()()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-33-4 name=__codelineno-33-4></a><a href=#__codelineno-33-4><span class=linenos data-linenos="4 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-33-5 name=__codelineno-33-5></a><a href=#__codelineno-33-5><span class=linenos data-linenos="5 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-33-6 name=__codelineno-33-6></a><a href=#__codelineno-33-6><span class=linenos data-linenos="6 "></span></a>
<a id=__codelineno-33-7 name=__codelineno-33-7></a><a href=#__codelineno-33-7><span class=linenos data-linenos="7 "></span></a><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-33-8 name=__codelineno-33-8></a><a href=#__codelineno-33-8><span class=linenos data-linenos="8 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-33-9 name=__codelineno-33-9></a><a href=#__codelineno-33-9><span class=linenos data-linenos="9 "></span></a><span class=p>};</span>
</code></pre></div> <p>如你所见，现在调用操作符就可以修改捕获的成员变量了。</p> <blockquote> <p>代码 2-8 <a href=https://wandbox.org/permlink/yQZUOIcK1ncKIyEI>通过值捕获两个 mutable 变量</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-34-1 name=__codelineno-34-1></a><a href=#__codelineno-34-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-34-2 name=__codelineno-34-2></a><a href=#__codelineno-34-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-34-3 name=__codelineno-34-3></a><a href=#__codelineno-34-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-34-4 name=__codelineno-34-4></a><a href=#__codelineno-34-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>print</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=k>const</span><span class=w> </span><span class=kt>char</span><span class=o>*</span><span class=w> </span><span class=n>str</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>y</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-34-5 name=__codelineno-34-5></a><a href=#__codelineno-34-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot; &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-34-6 name=__codelineno-34-6></a><a href=#__codelineno-34-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-34-7 name=__codelineno-34-7></a><a href=#__codelineno-34-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-34-8 name=__codelineno-34-8></a><a href=#__codelineno-34-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-34-9 name=__codelineno-34-9></a><a href=#__codelineno-34-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=s>&quot;in main()&quot;</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>);</span>
<a id=__codelineno-34-10 name=__codelineno-34-10></a><a href=#__codelineno-34-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-34-11 name=__codelineno-34-11></a><a href=#__codelineno-34-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>print</span><span class=p>]()</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-34-12 name=__codelineno-34-12></a><a href=#__codelineno-34-12><span class=linenos data-linenos="12 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-34-13 name=__codelineno-34-13></a><a href=#__codelineno-34-13><span class=linenos data-linenos="13 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-34-14 name=__codelineno-34-14></a><a href=#__codelineno-34-14><span class=linenos data-linenos="14 "></span></a><span class=w>        </span><span class=n>print</span><span class=p>(</span><span class=s>&quot;in foo()&quot;</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>);</span>
<a id=__codelineno-34-15 name=__codelineno-34-15></a><a href=#__codelineno-34-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-34-16 name=__codelineno-34-16></a><a href=#__codelineno-34-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-34-17 name=__codelineno-34-17></a><a href=#__codelineno-34-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=n>foo</span><span class=p>();</span>
<a id=__codelineno-34-18 name=__codelineno-34-18></a><a href=#__codelineno-34-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=n>print</span><span class=p>(</span><span class=s>&quot;in main()&quot;</span><span class=p>,</span><span class=w> </span><span class=n>x</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=p>);</span>
<a id=__codelineno-34-19 name=__codelineno-34-19></a><a href=#__codelineno-34-19><span class=linenos data-linenos="19 "></span></a><span class=p>}</span>
</code></pre></div> <p>输出：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-35-1 name=__codelineno-35-1></a><a href=#__codelineno-35-1><span class=linenos data-linenos="1 "></span></a>in main(): 1 1
<a id=__codelineno-35-2 name=__codelineno-35-2></a><a href=#__codelineno-35-2><span class=linenos data-linenos="2 "></span></a>in foo(): 2 2
<a id=__codelineno-35-3 name=__codelineno-35-3></a><a href=#__codelineno-35-3><span class=linenos data-linenos="3 "></span></a>in main(): 1 1
</code></pre></div> <p>在上述的例子中，我们可以修改 <code>x</code> 和 <code>y</code> 的值。</p> <p>但是，由于是从封闭区域中获取的拷贝值，所以在调用 <code>foo</code> 之后，我们无法获取到在局部区域修改的新值。</p> <p>另一方面，如果使用引用捕获，那么就不需要使用 <code>mutable</code> 修饰符来修改值了。</p> <p>这是因为捕获的成员变量是“引用”过来的，并且不能和内部的 <code>const</code> 成员函数所绑定，所以可以对它的内容作出修改。</p> <blockquote> <p>代码 2-9 通过引用捕获一个变量</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-36-1 name=__codelineno-36-1></a><a href=#__codelineno-36-1><span class=linenos data-linenos="1 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-36-2 name=__codelineno-36-2></a><a href=#__codelineno-36-2><span class=linenos data-linenos="2 "></span></a><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-36-3 name=__codelineno-36-3></a><a href=#__codelineno-36-3><span class=linenos data-linenos="3 "></span></a>
<a id=__codelineno-36-4 name=__codelineno-36-4></a><a href=#__codelineno-36-4><span class=linenos data-linenos="4 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>x</span><span class=p>]()</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-36-5 name=__codelineno-36-5></a><a href=#__codelineno-36-5><span class=linenos data-linenos="5 "></span></a><span class=w>    </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-36-6 name=__codelineno-36-6></a><a href=#__codelineno-36-6><span class=linenos data-linenos="6 "></span></a><span class=p>};</span>
<a id=__codelineno-36-7 name=__codelineno-36-7></a><a href=#__codelineno-36-7><span class=linenos data-linenos="7 "></span></a>
<a id=__codelineno-36-8 name=__codelineno-36-8></a><a href=#__codelineno-36-8><span class=linenos data-linenos="8 "></span></a><span class=n>foo</span><span class=p>();</span>
<a id=__codelineno-36-9 name=__codelineno-36-9></a><a href=#__codelineno-36-9><span class=linenos data-linenos="9 "></span></a><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
</code></pre></div> <p>这个例子中，Lambda 并没有应用 <code>mutable</code> 修饰符，但是我们可以修改引用的值。</p> <p>需要注意的一点：当使用 <code>mutable</code> 修饰符后，就无法使用 <code>const</code> 修饰符来修饰闭包对象了，因为它会阻止你调用这个 Lambda。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-37-1 name=__codelineno-37-1></a><a href=#__codelineno-37-1><span class=linenos data-linenos="1 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=mi>10</span><span class=p>;</span>
<a id=__codelineno-37-2 name=__codelineno-37-2></a><a href=#__codelineno-37-2><span class=linenos data-linenos="2 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>lam</span><span class=w> </span><span class=o>=</span><span class=p>[</span><span class=n>x</span><span class=p>]()</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=o>++</span><span class=n>x</span><span class=p>;</span><span class=w> </span><span class=p>}</span>
<a id=__codelineno-37-3 name=__codelineno-37-3></a><a href=#__codelineno-37-3><span class=linenos data-linenos="3 "></span></a><span class=n>lam</span><span class=p>();</span><span class=w> </span><span class=c1>// 无法编译</span>
</code></pre></div> <p>由于无法在 <code>const</code> 对象中调用非 <code>const</code> 成员函数，最后一行将提示编译失败。</p> <h3 id=调用计数器---捕获变量的一个例子>调用计数器 - 捕获变量的一个例子<a class=headerlink href=#调用计数器---捕获变量的一个例子 title="Permanent link"></a></h3> <p>在我们深入探究捕获之前，先来看看一个有关 Lambda 使用的例子：</p> <p>当你想使用一些现存的 STL 中的算法函数并改变默认行为规则时，用 Lambda 表达式是十分方便的。比如，对于 <code>std::sort</code> 函数，你可以写一个自定义的比较函数。</p> <p>当然，我们也可以进一步强化比较函数的功能：调用计数。</p> <blockquote> <p>代码 2-10 <a href=https://godbolt.org/z/jG5xK7>调用计数器</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-38-1 name=__codelineno-38-1></a><a href=#__codelineno-38-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;algorithm&gt;</span>
<a id=__codelineno-38-2 name=__codelineno-38-2></a><a href=#__codelineno-38-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-38-3 name=__codelineno-38-3></a><a href=#__codelineno-38-3><span class=linenos data-linenos=" 3 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
<a id=__codelineno-38-4 name=__codelineno-38-4></a><a href=#__codelineno-38-4><span class=linenos data-linenos=" 4 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-5 name=__codelineno-38-5></a><a href=#__codelineno-38-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>vec</span><span class=p>{</span><span class=mi>0</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>9</span><span class=p>,</span><span class=w> </span><span class=mi>7</span><span class=p>,</span><span class=w> </span><span class=mi>6</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>8</span><span class=p>};</span>
<a id=__codelineno-38-6 name=__codelineno-38-6></a><a href=#__codelineno-38-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>compCounter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-38-7 name=__codelineno-38-7></a><a href=#__codelineno-38-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-38-8 name=__codelineno-38-8></a><a href=#__codelineno-38-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>sort</span><span class=p>(</span><span class=n>vec</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>vec</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>compCounter</span><span class=p>](</span><span class=kt>int</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-38-9 name=__codelineno-38-9></a><a href=#__codelineno-38-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>compCounter</span><span class=p>;</span>
<a id=__codelineno-38-10 name=__codelineno-38-10></a><a href=#__codelineno-38-10><span class=linenos data-linenos="10 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>a</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
<a id=__codelineno-38-11 name=__codelineno-38-11></a><a href=#__codelineno-38-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=p>});</span>
<a id=__codelineno-38-12 name=__codelineno-38-12></a><a href=#__codelineno-38-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-38-13 name=__codelineno-38-13></a><a href=#__codelineno-38-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;number of comparisons: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>compCounter</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-38-14 name=__codelineno-38-14></a><a href=#__codelineno-38-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-38-15 name=__codelineno-38-15></a><a href=#__codelineno-38-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>vec</span><span class=p>)</span>
<a id=__codelineno-38-16 name=__codelineno-38-16></a><a href=#__codelineno-38-16><span class=linenos data-linenos="16 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>v</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;, &quot;</span><span class=p>;</span>
<a id=__codelineno-38-17 name=__codelineno-38-17></a><a href=#__codelineno-38-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <p>自定义的比较器和默认比较器是一致的，返回二者较小的那一个，即自然排序（升序排列）。</p> <p>同时，Lambda 也向 <code>std::sort</code> 传入了捕获的本地变量 <code>compCounter</code> 来计数调用了在排序过程中多少次的比较器。</p> <h3 id=捕获全局变量>捕获全局变量<a class=headerlink href=#捕获全局变量 title="Permanent link"></a></h3> <p>如果有一个全局变量，并且在 Lambda 使用了 <code>[=]</code>，也许你会认为这样就可以值捕获全局变量了，很遗憾，事实并非如此：</p> <blockquote> <p>代码 2-11 <a href=https://wandbox.org/permlink/n8wCuoeej8mGscql>捕获全局变量</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-39-1 name=__codelineno-39-1></a><a href=#__codelineno-39-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-39-2 name=__codelineno-39-2></a><a href=#__codelineno-39-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-39-3 name=__codelineno-39-3></a><a href=#__codelineno-39-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>global</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
<a id=__codelineno-39-4 name=__codelineno-39-4></a><a href=#__codelineno-39-4><span class=linenos data-linenos=" 4 "></span></a>
<a id=__codelineno-39-5 name=__codelineno-39-5></a><a href=#__codelineno-39-5><span class=linenos data-linenos=" 5 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-39-6 name=__codelineno-39-6></a><a href=#__codelineno-39-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>global</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-39-7 name=__codelineno-39-7></a><a href=#__codelineno-39-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-39-8 name=__codelineno-39-8></a><a href=#__codelineno-39-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>=</span><span class=p>]()</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-39-9 name=__codelineno-39-9></a><a href=#__codelineno-39-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>global</span><span class=p>;</span>
<a id=__codelineno-39-10 name=__codelineno-39-10></a><a href=#__codelineno-39-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-39-11 name=__codelineno-39-11></a><a href=#__codelineno-39-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=n>foo</span><span class=p>();</span>
<a id=__codelineno-39-12 name=__codelineno-39-12></a><a href=#__codelineno-39-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>global</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-39-13 name=__codelineno-39-13></a><a href=#__codelineno-39-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-39-14 name=__codelineno-39-14></a><a href=#__codelineno-39-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>increaseGlobal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[]()</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-39-15 name=__codelineno-39-15></a><a href=#__codelineno-39-15><span class=linenos data-linenos="15 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>global</span><span class=p>;</span>
<a id=__codelineno-39-16 name=__codelineno-39-16></a><a href=#__codelineno-39-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-39-17 name=__codelineno-39-17></a><a href=#__codelineno-39-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=n>increaseGlobal</span><span class=p>();</span>
<a id=__codelineno-39-18 name=__codelineno-39-18></a><a href=#__codelineno-39-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>global</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-39-19 name=__codelineno-39-19></a><a href=#__codelineno-39-19><span class=linenos data-linenos="19 "></span></a>
<a id=__codelineno-39-20 name=__codelineno-39-20></a><a href=#__codelineno-39-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>moreIncreaseGlobal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>global</span><span class=p>]()</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-39-21 name=__codelineno-39-21></a><a href=#__codelineno-39-21><span class=linenos data-linenos="21 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>global</span><span class=p>;</span>
<a id=__codelineno-39-22 name=__codelineno-39-22></a><a href=#__codelineno-39-22><span class=linenos data-linenos="22 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-39-23 name=__codelineno-39-23></a><a href=#__codelineno-39-23><span class=linenos data-linenos="23 "></span></a><span class=w>    </span><span class=n>moreIncreaseGlobal</span><span class=p>();</span>
<a id=__codelineno-39-24 name=__codelineno-39-24></a><a href=#__codelineno-39-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>global</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-39-25 name=__codelineno-39-25></a><a href=#__codelineno-39-25><span class=linenos data-linenos="25 "></span></a><span class=p>}</span>
</code></pre></div> <p>这个例子定义了全局变量 <code>global</code> 并且将它使用在多个 Lambda 表达式中，但是如果你运行这个程序会发现，无论通过何种方式捕获全局变量，都会发现它永远指向的是那个全局对象，而不会创建任何一个本地的拷贝对象出来。</p> <p>这是因为，只有在自动存储期间的变量会被捕获。GCC 甚至会对此提出警告：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-40-1 name=__codelineno-40-1></a><a href=#__codelineno-40-1><span class=linenos data-linenos="1 "></span></a>warning: capture of variable &#39;global&#39; with non-automatic storage duration.
</code></pre></div> <p>这个警告只会在显式捕获一个全局变量时出现，即便你用 <code>[=]</code>，编译器也无法帮你消除这个错误。</p> <p>在 Clang 中甚至会直接提示错误：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-41-1 name=__codelineno-41-1></a><a href=#__codelineno-41-1><span class=linenos data-linenos="1 "></span></a>error: &#39;global&#39; cannot be captured because it does not have
<a id=__codelineno-41-2 name=__codelineno-41-2></a><a href=#__codelineno-41-2><span class=linenos data-linenos="2 "></span></a>        automatic storage duration
</code></pre></div> <h3 id=捕获静态变量>捕获静态变量<a class=headerlink href=#捕获静态变量 title="Permanent link"></a></h3> <p>和捕获全局变量类似，在捕获静态变量的时候也会遇到类似的问题。</p> <blockquote> <p>代码 2-12 <a href=https://wandbox.org/permlink/CpJt4PUSleIJNVf2>捕获静态变量</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-42-1 name=__codelineno-42-1></a><a href=#__codelineno-42-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-42-2 name=__codelineno-42-2></a><a href=#__codelineno-42-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-42-3 name=__codelineno-42-3></a><a href=#__codelineno-42-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>void</span><span class=w> </span><span class=nf>bar</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-4 name=__codelineno-42-4></a><a href=#__codelineno-42-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>static_int</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
<a id=__codelineno-42-5 name=__codelineno-42-5></a><a href=#__codelineno-42-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>static_int</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-42-6 name=__codelineno-42-6></a><a href=#__codelineno-42-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>=</span><span class=p>]()</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-7 name=__codelineno-42-7></a><a href=#__codelineno-42-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>static_int</span><span class=p>;</span>
<a id=__codelineno-42-8 name=__codelineno-42-8></a><a href=#__codelineno-42-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-42-9 name=__codelineno-42-9></a><a href=#__codelineno-42-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=n>foo</span><span class=p>();</span>
<a id=__codelineno-42-10 name=__codelineno-42-10></a><a href=#__codelineno-42-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>static_int</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-42-11 name=__codelineno-42-11></a><a href=#__codelineno-42-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>increase</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[]()</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-12 name=__codelineno-42-12></a><a href=#__codelineno-42-12><span class=linenos data-linenos="12 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>static_int</span><span class=p>;</span>
<a id=__codelineno-42-13 name=__codelineno-42-13></a><a href=#__codelineno-42-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-42-14 name=__codelineno-42-14></a><a href=#__codelineno-42-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=n>increase</span><span class=p>();</span>
<a id=__codelineno-42-15 name=__codelineno-42-15></a><a href=#__codelineno-42-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>static_int</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-42-16 name=__codelineno-42-16></a><a href=#__codelineno-42-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>moreIncrease</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>static_int</span><span class=p>]()</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-17 name=__codelineno-42-17></a><a href=#__codelineno-42-17><span class=linenos data-linenos="17 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>static_int</span><span class=p>;</span>
<a id=__codelineno-42-18 name=__codelineno-42-18></a><a href=#__codelineno-42-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-42-19 name=__codelineno-42-19></a><a href=#__codelineno-42-19><span class=linenos data-linenos="19 "></span></a><span class=w>    </span><span class=n>moreIncrease</span><span class=p>();</span>
<a id=__codelineno-42-20 name=__codelineno-42-20></a><a href=#__codelineno-42-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>static_int</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-42-21 name=__codelineno-42-21></a><a href=#__codelineno-42-21><span class=linenos data-linenos="21 "></span></a><span class=p>}</span>
<a id=__codelineno-42-22 name=__codelineno-42-22></a><a href=#__codelineno-42-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-42-23 name=__codelineno-42-23></a><a href=#__codelineno-42-23><span class=linenos data-linenos="23 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-42-24 name=__codelineno-42-24></a><a href=#__codelineno-42-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class=n>bar</span><span class=p>();</span>
<a id=__codelineno-42-25 name=__codelineno-42-25></a><a href=#__codelineno-42-25><span class=linenos data-linenos="25 "></span></a><span class=p>}</span>
</code></pre></div> <p>这一次，我们尝试捕获静态变量并修改它的值，但是由于它没有自动存储时间，编译器并不会允许你这么做。（GCC 会提示警告，而 Clang 会直接报错）</p> <p>输出：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-43-1 name=__codelineno-43-1></a><a href=#__codelineno-43-1><span class=linenos data-linenos="1 "></span></a>10
<a id=__codelineno-43-2 name=__codelineno-43-2></a><a href=#__codelineno-43-2><span class=linenos data-linenos="2 "></span></a>11
<a id=__codelineno-43-3 name=__codelineno-43-3></a><a href=#__codelineno-43-3><span class=linenos data-linenos="3 "></span></a>12
<a id=__codelineno-43-4 name=__codelineno-43-4></a><a href=#__codelineno-43-4><span class=linenos data-linenos="4 "></span></a>13
</code></pre></div> <h3 id=捕获类成员和-this-指针>捕获类成员和 <code>this</code> 指针<a class=headerlink href=#捕获类成员和-this-指针 title="Permanent link"></a></h3> <p>当你想在一个类的成员函数中尝试捕获一个成员变量，那么事情就会稍微变得有点复杂。</p> <p>由于所有的数据成员都是和 <code>this</code> 指针关联起来的，当然了，这玩意必须被存储在某个地方。</p> <blockquote> <p>代码 2-13 <a href=https://wandbox.org/permlink/mp5VgqIyu5LWLn0f>捕获成员变量时的错误</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-44-1 name=__codelineno-44-1></a><a href=#__codelineno-44-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-44-2 name=__codelineno-44-2></a><a href=#__codelineno-44-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-44-3 name=__codelineno-44-3></a><a href=#__codelineno-44-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>Baz</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-44-4 name=__codelineno-44-4></a><a href=#__codelineno-44-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-44-5 name=__codelineno-44-5></a><a href=#__codelineno-44-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>        </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>lam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>s</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-44-6 name=__codelineno-44-6></a><a href=#__codelineno-44-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
<a id=__codelineno-44-7 name=__codelineno-44-7></a><a href=#__codelineno-44-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>        </span><span class=p>};</span>
<a id=__codelineno-44-8 name=__codelineno-44-8></a><a href=#__codelineno-44-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=n>lam</span><span class=p>();</span>
<a id=__codelineno-44-9 name=__codelineno-44-9></a><a href=#__codelineno-44-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-44-10 name=__codelineno-44-10></a><a href=#__codelineno-44-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
<a id=__codelineno-44-11 name=__codelineno-44-11></a><a href=#__codelineno-44-11><span class=linenos data-linenos="11 "></span></a><span class=p>};</span>
<a id=__codelineno-44-12 name=__codelineno-44-12></a><a href=#__codelineno-44-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-44-13 name=__codelineno-44-13></a><a href=#__codelineno-44-13><span class=linenos data-linenos="13 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-44-14 name=__codelineno-44-14></a><a href=#__codelineno-44-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=n>Baz</span><span class=w> </span><span class=n>b</span><span class=p>;</span>
<a id=__codelineno-44-15 name=__codelineno-44-15></a><a href=#__codelineno-44-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=n>b</span><span class=p>.</span><span class=n>foo</span><span class=p>();</span>
<a id=__codelineno-44-16 name=__codelineno-44-16></a><a href=#__codelineno-44-16><span class=linenos data-linenos="16 "></span></a><span class=p>}</span>
</code></pre></div> <p>这段代码尝试去捕获一个成员变量，但是编译器并不同意，这会导致编译器编译错误：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-45-1 name=__codelineno-45-1></a><a href=#__codelineno-45-1><span class=linenos data-linenos="1 "></span></a>In member function &#39;void Baz::foo()&#39;:
<a id=__codelineno-45-2 name=__codelineno-45-2></a><a href=#__codelineno-45-2><span class=linenos data-linenos="2 "></span></a>error: capture of non-variable &#39;Baz::s&#39;
<a id=__codelineno-45-3 name=__codelineno-45-3></a><a href=#__codelineno-45-3><span class=linenos data-linenos="3 "></span></a>error: &#39;this&#39; was not captured for this lambda function
</code></pre></div> <p>为解决此问题，需要捕获 <code>this</code> 指针。这样就能访问到成员变量了。</p> <p>而上面的代码也可以这样修改：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-46-1 name=__codelineno-46-1></a><a href=#__codelineno-46-1><span class=linenos data-linenos="1 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>Baz</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-46-2 name=__codelineno-46-2></a><a href=#__codelineno-46-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>foo</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-46-3 name=__codelineno-46-3></a><a href=#__codelineno-46-3><span class=linenos data-linenos="3 "></span></a><span class=w>        </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>lam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=k>this</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-46-4 name=__codelineno-46-4></a><a href=#__codelineno-46-4><span class=linenos data-linenos="4 "></span></a><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
<a id=__codelineno-46-5 name=__codelineno-46-5></a><a href=#__codelineno-46-5><span class=linenos data-linenos="5 "></span></a><span class=w>        </span><span class=p>};</span>
<a id=__codelineno-46-6 name=__codelineno-46-6></a><a href=#__codelineno-46-6><span class=linenos data-linenos="6 "></span></a><span class=w>        </span><span class=n>lam</span><span class=p>();</span>
<a id=__codelineno-46-7 name=__codelineno-46-7></a><a href=#__codelineno-46-7><span class=linenos data-linenos="7 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-46-8 name=__codelineno-46-8></a><a href=#__codelineno-46-8><span class=linenos data-linenos="8 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
<a id=__codelineno-46-9 name=__codelineno-46-9></a><a href=#__codelineno-46-9><span class=linenos data-linenos="9 "></span></a><span class=p>};</span>
</code></pre></div> <p>这样就不会有编译错误了。</p> <p>当然了，你也可以使用 <code>[=]</code> 或者 <code>[&amp;]</code> 来捕获 <code>this</code> 指针，在 C++11/14 中他们的效果是一样的。</p> <p>但是，请注意，值捕获 <code>this</code> 也是捕获指针，这就是为什么你能访问成员变量的原因。</p> <p>在 C++11/14 中，你不能够这样写：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-47-1 name=__codelineno-47-1></a><a href=#__codelineno-47-1><span class=linenos data-linenos="1 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>lam</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>*</span><span class=k>this</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-47-2 name=__codelineno-47-2></a><a href=#__codelineno-47-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
<a id=__codelineno-47-3 name=__codelineno-47-3></a><a href=#__codelineno-47-3><span class=linenos data-linenos="3 "></span></a><span class=p>};</span>
</code></pre></div> <p>但是它在 C++17 中是允许的。</p> <p>如果你在单一方法的上下文中使用捕获 <code>this</code>，这挺好的。</p> <p>但是稍微复杂的场景下使用捕获 <code>this</code> 呢？</p> <blockquote> <p>代码 2-14 从方法中返回 Lambda</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-48-1 name=__codelineno-48-1></a><a href=#__codelineno-48-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
<a id=__codelineno-48-2 name=__codelineno-48-2></a><a href=#__codelineno-48-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-48-3 name=__codelineno-48-3></a><a href=#__codelineno-48-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-48-4 name=__codelineno-48-4></a><a href=#__codelineno-48-4><span class=linenos data-linenos=" 4 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>Baz</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-48-5 name=__codelineno-48-5></a><a href=#__codelineno-48-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=n>foo</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-48-6 name=__codelineno-48-6></a><a href=#__codelineno-48-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>[</span><span class=o>=</span><span class=p>]</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-48-7 name=__codelineno-48-7></a><a href=#__codelineno-48-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-48-8 name=__codelineno-48-8></a><a href=#__codelineno-48-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=p>};</span>
<a id=__codelineno-48-9 name=__codelineno-48-9></a><a href=#__codelineno-48-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-48-10 name=__codelineno-48-10></a><a href=#__codelineno-48-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
<a id=__codelineno-48-11 name=__codelineno-48-11></a><a href=#__codelineno-48-11><span class=linenos data-linenos="11 "></span></a><span class=p>};</span>
<a id=__codelineno-48-12 name=__codelineno-48-12></a><a href=#__codelineno-48-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-48-13 name=__codelineno-48-13></a><a href=#__codelineno-48-13><span class=linenos data-linenos="13 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-48-14 name=__codelineno-48-14></a><a href=#__codelineno-48-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>f1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Baz</span><span class=p>{</span><span class=s>&quot;abc&quot;</span><span class=p>}.</span><span class=n>foo</span><span class=p>();</span>
<a id=__codelineno-48-15 name=__codelineno-48-15></a><a href=#__codelineno-48-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>f2</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Baz</span><span class=p>{</span><span class=s>&quot;xyz&quot;</span><span class=p>}.</span><span class=n>foo</span><span class=p>();</span>
<a id=__codelineno-48-16 name=__codelineno-48-16></a><a href=#__codelineno-48-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=n>f1</span><span class=p>();</span>
<a id=__codelineno-48-17 name=__codelineno-48-17></a><a href=#__codelineno-48-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=n>f2</span><span class=p>();</span>
<a id=__codelineno-48-18 name=__codelineno-48-18></a><a href=#__codelineno-48-18><span class=linenos data-linenos="18 "></span></a><span class=p>}</span>
</code></pre></div> <p>代码中声明了 <code>Baz</code> 这个对象，并且调用了 <code>foo()</code>。</p> <p>请注意，<code>foo()</code> 返回了一个从类中捕获成员的 Lambda（存储在 <code>std::function</code> 中）。</p> <p><code>std::function</code> 在 C++11 中是必需的，因为常规函数没有返回类型推导。</p> <p>但是 C++14 支持函数返回类型的推导。</p> <p>由于我们使用的是临时对象，我们不能保证当我们调用 <code>f1</code> 和 <code>f2</code> 时会发生什么。</p> <p>这是一个悬空引用的问题，并且是未定义行为（Undefined Behaviour）。</p> <p>这种行为类似于下面这段代码：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-49-1 name=__codelineno-49-1></a><a href=#__codelineno-49-1><span class=linenos data-linenos="1 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>Bar</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-49-2 name=__codelineno-49-2></a><a href=#__codelineno-49-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=k>const</span><span class=o>&amp;</span><span class=w> </span><span class=n>foo</span><span class=p>()</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-49-3 name=__codelineno-49-3></a><a href=#__codelineno-49-3><span class=linenos data-linenos="3 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
<a id=__codelineno-49-4 name=__codelineno-49-4></a><a href=#__codelineno-49-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-49-5 name=__codelineno-49-5></a><a href=#__codelineno-49-5><span class=linenos data-linenos="5 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>s</span><span class=p>;</span>
<a id=__codelineno-49-6 name=__codelineno-49-6></a><a href=#__codelineno-49-6><span class=linenos data-linenos="6 "></span></a><span class=p>};</span>
<a id=__codelineno-49-7 name=__codelineno-49-7></a><a href=#__codelineno-49-7><span class=linenos data-linenos="7 "></span></a><span class=k>auto</span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>f1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Bar</span><span class=p>{</span><span class=s>&quot;abc&quot;</span><span class=p>}.</span><span class=n>foo</span><span class=p>();</span><span class=w>  </span><span class=c1>// 一个悬空引用</span>
</code></pre></div> <p>当然，如果你显式捕获，也是 <a href=https://wandbox.org/permlink/FOgbNGoQHOmepBgY>一样</a> 的。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-50-1 name=__codelineno-50-1></a><a href=#__codelineno-50-1><span class=linenos data-linenos="1 "></span></a><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=kt>void</span><span class=p>()</span><span class=o>&gt;</span><span class=w> </span><span class=n>foo</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-50-2 name=__codelineno-50-2></a><a href=#__codelineno-50-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=p>[</span><span class=n>s</span><span class=p>]</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-50-3 name=__codelineno-50-3></a><a href=#__codelineno-50-3><span class=linenos data-linenos="3 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-50-4 name=__codelineno-50-4></a><a href=#__codelineno-50-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-50-5 name=__codelineno-50-5></a><a href=#__codelineno-50-5><span class=linenos data-linenos="5 "></span></a><span class=p>}</span>
</code></pre></div> <p>总而言之，当 Lambda 生命周期比对象更长时，捕获 <code>this</code> 可能会变得棘手。</p> <p>当您使用异步调用或多线程时，可能会发生这种情况。</p> <p>在 C++17 章节中，我们会重新详细讨论这个话题</p> <h3 id=只能移动的对象>只能移动的对象<a class=headerlink href=#只能移动的对象 title="Permanent link"></a></h3> <p>假如，现在有一个“仅可移动”的对象（像 <code>unique_ptr</code>），那么你就无法将它作为捕获对象移动到 Lambda 中。</p> <p>值捕获将不起作用，只能进行引用捕获。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-51-1 name=__codelineno-51-1></a><a href=#__codelineno-51-1><span class=linenos data-linenos="1 "></span></a><span class=n>std</span><span class=o>::</span><span class=n>unique_ptr</span><span class=o>&lt;</span><span class=kt>int</span><span class=o>&gt;</span><span class=w> </span><span class=n>p</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=kt>int</span><span class=p>{</span><span class=mi>10</span><span class=p>});</span>
<a id=__codelineno-51-2 name=__codelineno-51-2></a><a href=#__codelineno-51-2><span class=linenos data-linenos="2 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>p</span><span class=p>]()</span><span class=w> </span><span class=p>{};</span><span class=w>       </span><span class=c1>// does not compile....</span>
<a id=__codelineno-51-3 name=__codelineno-51-3></a><a href=#__codelineno-51-3><span class=linenos data-linenos="3 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>foo_ref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>p</span><span class=p>]()</span><span class=w> </span><span class=p>{};</span><span class=w>  </span><span class=c1>// compiles, but the ownership is not passed</span>
</code></pre></div> <p>上述例子中，你会发现捕获 <code>unique_ptr</code> 的唯一方式是引用捕获，但是这种方式并不是最好的方式，因为它并没有将 <code>unique_ptr</code> 的所属权进行转移。</p> <p>在下一章 C++14 中，由于初始化捕获的引入，这个问题会被修复。你可以在初始化捕获直接查阅内容。</p> <h3 id=保留常量>保留常量<a class=headerlink href=#保留常量 title="Permanent link"></a></h3> <p>如果捕获一个 <code>const</code> 修饰的变量，那么它的常量性将会被保留。</p> <blockquote> <p>代码 2-15 <a href=https://wandbox.org/permlink/h8lCuOXd9dHsopG1>保留常量的 <code>const</code> 特性</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-52-1 name=__codelineno-52-1></a><a href=#__codelineno-52-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-52-2 name=__codelineno-52-2></a><a href=#__codelineno-52-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;type_traits&gt;</span>
<a id=__codelineno-52-3 name=__codelineno-52-3></a><a href=#__codelineno-52-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-52-4 name=__codelineno-52-4></a><a href=#__codelineno-52-4><span class=linenos data-linenos=" 4 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-52-5 name=__codelineno-52-5></a><a href=#__codelineno-52-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
<a id=__codelineno-52-6 name=__codelineno-52-6></a><a href=#__codelineno-52-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>foo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>x</span><span class=p>]()</span><span class=w> </span><span class=k>mutable</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-52-7 name=__codelineno-52-7></a><a href=#__codelineno-52-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>is_const</span><span class=o>&lt;</span><span class=k>decltype</span><span class=p>(</span><span class=n>x</span><span class=p>)</span><span class=o>&gt;::</span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>endl</span><span class=p>;</span>
<a id=__codelineno-52-8 name=__codelineno-52-8></a><a href=#__codelineno-52-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>11</span><span class=p>;</span>
<a id=__codelineno-52-9 name=__codelineno-52-9></a><a href=#__codelineno-52-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-52-10 name=__codelineno-52-10></a><a href=#__codelineno-52-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=n>foo</span><span class=p>();</span>
<a id=__codelineno-52-11 name=__codelineno-52-11></a><a href=#__codelineno-52-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
</code></pre></div> <p>这段代码将不会被编译器通过，因为捕获的对象是一个常量，即便使用 <code>mutable</code> 来修饰也无济于事。</p> <h3 id=捕获参数包>捕获参数包<a class=headerlink href=#捕获参数包 title="Permanent link"></a></h3> <p>为了结束我们对“捕获”的讨论，在最后我们来聊聊使用可变参数模板来进行捕获。</p> <p>编译器会将参数包扩展为非静态数据成员列表，如果您想在模板化代码中使用 Lambda，这会十分方便。代码示例：</p> <blockquote> <p>代码 2-16 <a href=https://wandbox.org/permlink/29qxFbLefKf3wnNU>捕获可变参数包</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-53-1 name=__codelineno-53-1></a><a href=#__codelineno-53-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-53-2 name=__codelineno-53-2></a><a href=#__codelineno-53-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;tuple&gt;</span>
<a id=__codelineno-53-3 name=__codelineno-53-3></a><a href=#__codelineno-53-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-53-4 name=__codelineno-53-4></a><a href=#__codelineno-53-4><span class=linenos data-linenos=" 4 "></span></a><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>class</span><span class=p>...</span><span class=w> </span><span class=n>Args</span><span class=o>&gt;</span>
<a id=__codelineno-53-5 name=__codelineno-53-5></a><a href=#__codelineno-53-5><span class=linenos data-linenos=" 5 "></span></a><span class=kt>void</span><span class=w> </span><span class=n>captureTest</span><span class=p>(</span><span class=n>Args</span><span class=p>...</span><span class=w> </span><span class=n>args</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-53-6 name=__codelineno-53-6></a><a href=#__codelineno-53-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>lambda</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=n>args</span><span class=p>...]</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-53-7 name=__codelineno-53-7></a><a href=#__codelineno-53-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>        </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>tup</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>make_tuple</span><span class=p>(</span><span class=n>args</span><span class=p>...);</span>
<a id=__codelineno-53-8 name=__codelineno-53-8></a><a href=#__codelineno-53-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;tuple size: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>tuple_size</span><span class=o>&lt;</span><span class=k>decltype</span><span class=p>(</span><span class=n>tup</span><span class=p>)</span><span class=o>&gt;::</span><span class=n>value</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-53-9 name=__codelineno-53-9></a><a href=#__codelineno-53-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;tuple 1st:  &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>get</span><span class=o>&lt;</span><span class=mi>0</span><span class=o>&gt;</span><span class=p>(</span><span class=n>tup</span><span class=p>)</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-53-10 name=__codelineno-53-10></a><a href=#__codelineno-53-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-53-11 name=__codelineno-53-11></a><a href=#__codelineno-53-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=n>lambda</span><span class=p>();</span><span class=w>  </span><span class=c1>// call it</span>
<a id=__codelineno-53-12 name=__codelineno-53-12></a><a href=#__codelineno-53-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
<a id=__codelineno-53-13 name=__codelineno-53-13></a><a href=#__codelineno-53-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-53-14 name=__codelineno-53-14></a><a href=#__codelineno-53-14><span class=linenos data-linenos="14 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-53-15 name=__codelineno-53-15></a><a href=#__codelineno-53-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=n>captureTest</span><span class=p>(</span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>);</span>
<a id=__codelineno-53-16 name=__codelineno-53-16></a><a href=#__codelineno-53-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=n>captureTest</span><span class=p>(</span><span class=s>&quot;Hello world&quot;</span><span class=p>,</span><span class=w> </span><span class=mf>10.0f</span><span class=p>);</span>
<a id=__codelineno-53-17 name=__codelineno-53-17></a><a href=#__codelineno-53-17><span class=linenos data-linenos="17 "></span></a><span class=p>}</span>
</code></pre></div> <p>运行这段代码，结果为：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-54-1 name=__codelineno-54-1></a><a href=#__codelineno-54-1><span class=linenos data-linenos="1 "></span></a>tuple size: 4
<a id=__codelineno-54-2 name=__codelineno-54-2></a><a href=#__codelineno-54-2><span class=linenos data-linenos="2 "></span></a>tuple 1st:  1
<a id=__codelineno-54-3 name=__codelineno-54-3></a><a href=#__codelineno-54-3><span class=linenos data-linenos="3 "></span></a>tuple size: 2
<a id=__codelineno-54-4 name=__codelineno-54-4></a><a href=#__codelineno-54-4><span class=linenos data-linenos="4 "></span></a>tuple 1st:  Hello world
</code></pre></div> <p>在这里展示了使用可变长参数包进行值捕获（引用捕获同理），捕获的对象“存储”在一个 <code>tuple</code> 对象中，可以使用一些辅助函数来访问 <code>tuple</code> 中的数据和属性。</p> <p>当然了，你也可以使用 <a href=https://cppinsights.io/s/19d3a45d>C++ Insight</a> 来观察编译器是如果生成这个代码并且展开模板、参数包和 Lambda 的。</p> <blockquote> <p>C++14 让捕获仅可移动类型成为可能，并且 C++20 中增强了对可变参数包的支持。</p> </blockquote> <h2 id=5-返回类型>5. 返回类型<a class=headerlink href=#5-返回类型 title="Permanent link"></a></h2> <p>在多数情况下，您可以跳过 Lambda 的返回类型，让编译器为您推导类型。</p> <p>最初，返回类型的推导仅限于函数体内仅包含单个 <code>return</code> 语句的 Lambda。</p> <p>但是，由于 C++ 标准实现了一个更便捷的版本，因此这限制很快就取消了。</p> <p>相关内容可以参考：<a href=http://www.open-std.org/jtc1/sc22/wg21/docs/cwg_defects.html#975>C++ Standard Core Language Defect Reports and Accepted Issues, Revision 104</a></p> <p>总结一下，从 C++11 开始，只要所有的 <code>return</code> 语句都是相同的类型，编译器就能够推断出返回类型。</p> <p>如果所有的 <code>return</code> 语句都返回了一个表达式，并且返回表达式的类型都经过了一个从左值到右值的转换（7.1 [conv.lavl]）或者从数组到指针的转换（7.2 [conv.array]）或者从函数到指针的转换（7.3 [conv.func]），那么他们的类型都是一样的，就是普通类型。</p> <blockquote> <p>代码 2-17 <a href=https://wandbox.org/permlink/sxtT30yKx9mwrYT3>返回类型推导</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-55-1 name=__codelineno-55-1></a><a href=#__codelineno-55-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;type_traits&gt;</span>
<a id=__codelineno-55-2 name=__codelineno-55-2></a><a href=#__codelineno-55-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-55-3 name=__codelineno-55-3></a><a href=#__codelineno-55-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-55-4 name=__codelineno-55-4></a><a href=#__codelineno-55-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>baz</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-55-5 name=__codelineno-55-5></a><a href=#__codelineno-55-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>x</span><span class=w> </span><span class=o>&lt;</span><span class=w> </span><span class=mi>20</span><span class=p>)</span>
<a id=__codelineno-55-6 name=__codelineno-55-6></a><a href=#__codelineno-55-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>1.1</span><span class=p>;</span>
<a id=__codelineno-55-7 name=__codelineno-55-7></a><a href=#__codelineno-55-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>        </span><span class=k>else</span>
<a id=__codelineno-55-8 name=__codelineno-55-8></a><a href=#__codelineno-55-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mf>2.1</span><span class=p>;</span>
<a id=__codelineno-55-9 name=__codelineno-55-9></a><a href=#__codelineno-55-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-55-10 name=__codelineno-55-10></a><a href=#__codelineno-55-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=k>static_assert</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>is_same</span><span class=o>&lt;</span><span class=kt>double</span><span class=p>,</span><span class=w> </span><span class=k>decltype</span><span class=p>(</span><span class=n>baz</span><span class=p>(</span><span class=mi>10</span><span class=p>))</span><span class=o>&gt;::</span><span class=n>value</span><span class=p>,</span><span class=w> </span><span class=s>&quot;has to be the same!&quot;</span><span class=p>);</span>
<a id=__codelineno-55-11 name=__codelineno-55-11></a><a href=#__codelineno-55-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
</code></pre></div> <p>上面的例子中，有两个返回语句，但是他们都指向 <code>double</code> 类型，所以编译器能够推断出最终的类型。</p> <p>在 C++14 中，推导常规函数时，lambda 的类型会自动更新以适应 <code>auto</code> 类型的规则。</p> <h3 id=尾部返回类型语法>尾部返回类型语法<a class=headerlink href=#尾部返回类型语法 title="Permanent link"></a></h3> <p>如果你想显式的凸显返回类型，那么可以使用尾部返回类型的语法。</p> <p>举个例子：</p> <blockquote> <p>代码 2-18 lambda 返回字符串序列</p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-56-1 name=__codelineno-56-1></a><a href=#__codelineno-56-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-56-2 name=__codelineno-56-2></a><a href=#__codelineno-56-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string&gt;</span>
<a id=__codelineno-56-3 name=__codelineno-56-3></a><a href=#__codelineno-56-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-56-4 name=__codelineno-56-4></a><a href=#__codelineno-56-4><span class=linenos data-linenos=" 4 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-56-5 name=__codelineno-56-5></a><a href=#__codelineno-56-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>testSpeedString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>speed</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-56-6 name=__codelineno-56-6></a><a href=#__codelineno-56-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>speed</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=p>)</span>
<a id=__codelineno-56-7 name=__codelineno-56-7></a><a href=#__codelineno-56-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=s>&quot;you&#39;re a super fast&quot;</span><span class=p>;</span>
<a id=__codelineno-56-8 name=__codelineno-56-8></a><a href=#__codelineno-56-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;you&#39;re a regular&quot;</span><span class=p>;</span>
<a id=__codelineno-56-9 name=__codelineno-56-9></a><a href=#__codelineno-56-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-56-10 name=__codelineno-56-10></a><a href=#__codelineno-56-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>testSpeedString</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
<a id=__codelineno-56-11 name=__codelineno-56-11></a><a href=#__codelineno-56-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=n>str</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=s>&quot; driver&quot;</span><span class=p>;</span><span class=w>  </span><span class=c1>// 出错! const char*类型没有+=操作符可以应用</span>
<a id=__codelineno-56-12 name=__codelineno-56-12></a><a href=#__codelineno-56-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>str</span><span class=p>;</span>
<a id=__codelineno-56-13 name=__codelineno-56-13></a><a href=#__codelineno-56-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-56-14 name=__codelineno-56-14></a><a href=#__codelineno-56-14><span class=linenos data-linenos="14 "></span></a><span class=p>}</span>
</code></pre></div> <p>当然，这段代码是无法编译的，因为编译器自动推断的类型结果是 const char*，作为 lambda 的返回类型，+= 操作符无法应用于 const char * 类型，所以编译器阻止了这种行为。</p> <p>当然，我们稍微修改一下，<a href=http://coliru.stacked-crooked.com/a/45cebc8b35d5b2a9>上述代码</a> 就可以正常工作了。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-57-1 name=__codelineno-57-1></a><a href=#__codelineno-57-1><span class=linenos data-linenos="1 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>testSpeedString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=kt>int</span><span class=w> </span><span class=n>speed</span><span class=p>)</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-57-2 name=__codelineno-57-2></a><a href=#__codelineno-57-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>speed</span><span class=w> </span><span class=o>&gt;</span><span class=w> </span><span class=mi>100</span><span class=p>)</span>
<a id=__codelineno-57-3 name=__codelineno-57-3></a><a href=#__codelineno-57-3><span class=linenos data-linenos="3 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;you&#39;re a super fast&quot;</span><span class=p>;</span>
<a id=__codelineno-57-4 name=__codelineno-57-4></a><a href=#__codelineno-57-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=s>&quot;you&#39;re a regular&quot;</span><span class=p>;</span>
<a id=__codelineno-57-5 name=__codelineno-57-5></a><a href=#__codelineno-57-5><span class=linenos data-linenos="5 "></span></a><span class=p>};</span>
<a id=__codelineno-57-6 name=__codelineno-57-6></a><a href=#__codelineno-57-6><span class=linenos data-linenos="6 "></span></a><span class=k>auto</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>testSpeedString</span><span class=p>(</span><span class=mi>100</span><span class=p>);</span>
<a id=__codelineno-57-7 name=__codelineno-57-7></a><a href=#__codelineno-57-7><span class=linenos data-linenos="7 "></span></a><span class=n>str</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=s>&quot; driver&quot;</span><span class=p>;</span>
</code></pre></div> <p>我们只是将 <code>noexcept</code> 移除，并更换为了 <code>std::string</code>。</p> <p>当然，你也可以使用命名空间 <code>std::string_literals</code> 然后返回 <code>std::string</code> 类型的 <code>“you're a regular”</code>。</p> <h2 id=6-转化为函数指针>6. 转化为函数指针<a class=headerlink href=#6-转化为函数指针 title="Permanent link"></a></h2> <p>当你的 Lambda 表达式没有捕获到任何变量时，编译器就会将其转换为一个常规函数指针。</p> <p>可以查看标准草案中 <a href=https://timsong-cpp.github.io/cppwp/n3337/expr.prim.lambda#6>[expr.prim.lambda#6]</a> 的定义：</p> <blockquote> <p>没有捕获的 Lambda 表达式的闭包类型具有公共非虚拟、非显式的 <code>const</code> 转换函数，指向与闭包类型的函数调用运算符具有相同参数和返回类型的函数的指针。</p> <p>此转换函数返回的值应为函数的地址，该函数在调用时与调用闭包类型的函数调用运算符具有相同的效果。</p> </blockquote> <p>为了阐明 Lambda 是如何支持这种转换，让我们考虑以下示例。</p> <p>它定义了一个明确定义转换运算符的仿函数 <code>baz</code>：</p> <blockquote> <p>代码 2-19 <a href=https://wandbox.org/permlink/XAmjjJiojnFKyd44>转化函数指针</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-58-1 name=__codelineno-58-1></a><a href=#__codelineno-58-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-58-2 name=__codelineno-58-2></a><a href=#__codelineno-58-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-58-3 name=__codelineno-58-3></a><a href=#__codelineno-58-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>void</span><span class=w> </span><span class=nf>callWith10</span><span class=p>(</span><span class=kt>void</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=n>bar</span><span class=p>)(</span><span class=kt>int</span><span class=p>))</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-58-4 name=__codelineno-58-4></a><a href=#__codelineno-58-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=n>bar</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
<a id=__codelineno-58-5 name=__codelineno-58-5></a><a href=#__codelineno-58-5><span class=linenos data-linenos=" 5 "></span></a><span class=p>}</span>
<a id=__codelineno-58-6 name=__codelineno-58-6></a><a href=#__codelineno-58-6><span class=linenos data-linenos=" 6 "></span></a>
<a id=__codelineno-58-7 name=__codelineno-58-7></a><a href=#__codelineno-58-7><span class=linenos data-linenos=" 7 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-58-8 name=__codelineno-58-8></a><a href=#__codelineno-58-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=k>struct</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-58-9 name=__codelineno-58-9></a><a href=#__codelineno-58-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>        </span><span class=k>using</span><span class=w> </span><span class=n>f_ptr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>int</span><span class=p>);</span>
<a id=__codelineno-58-10 name=__codelineno-58-10></a><a href=#__codelineno-58-10><span class=linenos data-linenos="10 "></span></a><span class=w>        </span><span class=kt>void</span><span class=w> </span><span class=k>operator</span><span class=p>()(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-58-11 name=__codelineno-58-11></a><a href=#__codelineno-58-11><span class=linenos data-linenos="11 "></span></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>call</span><span class=p>(</span><span class=n>s</span><span class=p>);</span>
<a id=__codelineno-58-12 name=__codelineno-58-12></a><a href=#__codelineno-58-12><span class=linenos data-linenos="12 "></span></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-58-13 name=__codelineno-58-13></a><a href=#__codelineno-58-13><span class=linenos data-linenos="13 "></span></a><span class=w>        </span><span class=k>operator</span><span class=w> </span><span class=n>f_ptr</span><span class=p>()</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-58-14 name=__codelineno-58-14></a><a href=#__codelineno-58-14><span class=linenos data-linenos="14 "></span></a><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=o>&amp;</span><span class=n>call</span><span class=p>;</span>
<a id=__codelineno-58-15 name=__codelineno-58-15></a><a href=#__codelineno-58-15><span class=linenos data-linenos="15 "></span></a><span class=w>        </span><span class=p>}</span>
<a id=__codelineno-58-16 name=__codelineno-58-16></a><a href=#__codelineno-58-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-58-17 name=__codelineno-58-17></a><a href=#__codelineno-58-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-58-18 name=__codelineno-58-18></a><a href=#__codelineno-58-18><span class=linenos data-linenos="18 "></span></a><span class=w>        </span><span class=k>static</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>call</span><span class=p>(</span><span class=kt>int</span><span class=w> </span><span class=n>s</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-58-19 name=__codelineno-58-19></a><a href=#__codelineno-58-19><span class=linenos data-linenos="19 "></span></a><span class=w>            </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-58-20 name=__codelineno-58-20></a><a href=#__codelineno-58-20><span class=linenos data-linenos="20 "></span></a><span class=w>        </span><span class=p>};</span>
<a id=__codelineno-58-21 name=__codelineno-58-21></a><a href=#__codelineno-58-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=n>baz</span><span class=p>;</span>
<a id=__codelineno-58-22 name=__codelineno-58-22></a><a href=#__codelineno-58-22><span class=linenos data-linenos="22 "></span></a>
<a id=__codelineno-58-23 name=__codelineno-58-23></a><a href=#__codelineno-58-23><span class=linenos data-linenos="23 "></span></a><span class=w>    </span><span class=n>callWith10</span><span class=p>(</span><span class=n>baz</span><span class=p>);</span>
<a id=__codelineno-58-24 name=__codelineno-58-24></a><a href=#__codelineno-58-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class=n>callWith10</span><span class=p>([](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-58-25 name=__codelineno-58-25></a><a href=#__codelineno-58-25><span class=linenos data-linenos="25 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-58-26 name=__codelineno-58-26></a><a href=#__codelineno-58-26><span class=linenos data-linenos="26 "></span></a><span class=w>    </span><span class=p>});</span>
<a id=__codelineno-58-27 name=__codelineno-58-27></a><a href=#__codelineno-58-27><span class=linenos data-linenos="27 "></span></a><span class=p>}</span>
</code></pre></div> <p>在这个程序中，有一个 <code>callWith10</code> 函数，它接受一个函数指针。</p> <p>然后我们用两个参数调用它（第 23 行和第 24 行）：第一个使用 <code>baz</code>，它是一个包含必要转换运算符的仿函数 - 它转换为 <code>f_ptr</code>，与 <code>callWith10</code> 的输入参数相同。第二个使用 Lambda。</p> <p>在这种情况下，编译器将执行所需的转换。</p> <p>当您需要调用需要回调的 C 风格的函数时，这种转换可能会很方便。</p> <p>例如，下面的代码是从 C 标准库中调用 <code>qsort</code> 函数，同时使用 Lambda 来进行反向排序。</p> <blockquote> <p>代码 2-20 <a href=https://wandbox.org/permlink/fEMhtqAXerDdCXG8>调用 C 风格函数</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-59-1 name=__codelineno-59-1></a><a href=#__codelineno-59-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;cstdlib&gt;</span>
<a id=__codelineno-59-2 name=__codelineno-59-2></a><a href=#__codelineno-59-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-59-3 name=__codelineno-59-3></a><a href=#__codelineno-59-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-59-4 name=__codelineno-59-4></a><a href=#__codelineno-59-4><span class=linenos data-linenos=" 4 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-59-5 name=__codelineno-59-5></a><a href=#__codelineno-59-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>values</span><span class=p>[]</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>{</span><span class=mi>8</span><span class=p>,</span><span class=w> </span><span class=mi>9</span><span class=p>,</span><span class=w> </span><span class=mi>2</span><span class=p>,</span><span class=w> </span><span class=mi>5</span><span class=p>,</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=mi>4</span><span class=p>,</span><span class=w> </span><span class=mi>7</span><span class=p>,</span><span class=w> </span><span class=mi>3</span><span class=p>,</span><span class=w> </span><span class=mi>6</span><span class=p>};</span>
<a id=__codelineno-59-6 name=__codelineno-59-6></a><a href=#__codelineno-59-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>constexpr</span><span class=w> </span><span class=kt>size_t</span><span class=w> </span><span class=n>numElements</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>values</span><span class=p>)</span><span class=w> </span><span class=o>/</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=n>values</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
<a id=__codelineno-59-7 name=__codelineno-59-7></a><a href=#__codelineno-59-7><span class=linenos data-linenos=" 7 "></span></a>
<a id=__codelineno-59-8 name=__codelineno-59-8></a><a href=#__codelineno-59-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>qsort</span><span class=p>(</span><span class=n>values</span><span class=p>,</span><span class=w> </span><span class=n>numElements</span><span class=p>,</span><span class=w> </span><span class=k>sizeof</span><span class=p>(</span><span class=kt>int</span><span class=p>),</span><span class=w> </span><span class=p>[](</span><span class=k>const</span><span class=w> </span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>a</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=kt>void</span><span class=o>*</span><span class=w> </span><span class=n>b</span><span class=p>)</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-59-9 name=__codelineno-59-9></a><a href=#__codelineno-59-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>(</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>b</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=o>*</span><span class=p>(</span><span class=kt>int</span><span class=o>*</span><span class=p>)</span><span class=n>a</span><span class=p>);</span>
<a id=__codelineno-59-10 name=__codelineno-59-10></a><a href=#__codelineno-59-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=p>});</span>
<a id=__codelineno-59-11 name=__codelineno-59-11></a><a href=#__codelineno-59-11><span class=linenos data-linenos="11 "></span></a>
<a id=__codelineno-59-12 name=__codelineno-59-12></a><a href=#__codelineno-59-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>values</span><span class=p>)</span>
<a id=__codelineno-59-13 name=__codelineno-59-13></a><a href=#__codelineno-59-13><span class=linenos data-linenos="13 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;, &quot;</span><span class=p>;</span>
<a id=__codelineno-59-14 name=__codelineno-59-14></a><a href=#__codelineno-59-14><span class=linenos data-linenos="14 "></span></a><span class=p>}</span>
</code></pre></div> <p>正如您在代码示例中看到的那样，使用 <code>std::qsort</code> 仅将函数指针作为比较器。</p> <p>编译器可以对我们传递的无状态 Lambda 进行隐式转换。</p> <h3 id=一个有趣的例子>一个有趣的例子<a class=headerlink href=#一个有趣的例子 title="Permanent link"></a></h3> <p>在讨论别的内容之前，这儿有一个可能十分有趣的例子，我们可以一起来研究下：</p> <blockquote> <p>代码 2-21 <a href=https://wandbox.org/permlink/0r0jDiJxlLuEzYwm>加号和 Lambda 表达式</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-60-1 name=__codelineno-60-1></a><a href=#__codelineno-60-1><span class=linenos data-linenos="1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;type_traits&gt;</span>
<a id=__codelineno-60-2 name=__codelineno-60-2></a><a href=#__codelineno-60-2><span class=linenos data-linenos="2 "></span></a>
<a id=__codelineno-60-3 name=__codelineno-60-3></a><a href=#__codelineno-60-3><span class=linenos data-linenos="3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-60-4 name=__codelineno-60-4></a><a href=#__codelineno-60-4><span class=linenos data-linenos="4 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>funcPtr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>+</span><span class=p>[]</span><span class=w> </span><span class=p>{};</span>
<a id=__codelineno-60-5 name=__codelineno-60-5></a><a href=#__codelineno-60-5><span class=linenos data-linenos="5 "></span></a><span class=w>    </span><span class=k>static_assert</span><span class=p>(</span><span class=n>std</span><span class=o>::</span><span class=n>is_same</span><span class=o>&lt;</span><span class=k>decltype</span><span class=p>(</span><span class=n>funcPtr</span><span class=p>),</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>)()</span><span class=o>&gt;::</span><span class=n>value</span><span class=p>);</span>
<a id=__codelineno-60-6 name=__codelineno-60-6></a><a href=#__codelineno-60-6><span class=linenos data-linenos="6 "></span></a><span class=p>}</span>
</code></pre></div> <p>注意一下这个“奇怪”的“<code>+</code>”运算符的语法，如果你去掉这个加号，那整个 <code>static_assert</code> 就失败了。</p> <p>这是什么神奇的原因？</p> <p>要理解其中的工作原理，我们得先看看 C++ 生成的代码是什么样的：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-61-1 name=__codelineno-61-1></a><a href=#__codelineno-61-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;type_traits&gt;</span>
<a id=__codelineno-61-2 name=__codelineno-61-2></a><a href=#__codelineno-61-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-61-3 name=__codelineno-61-3></a><a href=#__codelineno-61-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span>
<a id=__codelineno-61-4 name=__codelineno-61-4></a><a href=#__codelineno-61-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>{</span>
<a id=__codelineno-61-5 name=__codelineno-61-5></a><a href=#__codelineno-61-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-61-6 name=__codelineno-61-6></a><a href=#__codelineno-61-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>  </span><span class=k>class</span><span class=w> </span><span class=nc>__lambda_4_18</span>
<a id=__codelineno-61-7 name=__codelineno-61-7></a><a href=#__codelineno-61-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>  </span><span class=p>{</span>
<a id=__codelineno-61-8 name=__codelineno-61-8></a><a href=#__codelineno-61-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-61-9 name=__codelineno-61-9></a><a href=#__codelineno-61-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=kr>inline</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=k>operator</span><span class=p>()()</span><span class=w> </span><span class=k>const</span>
<a id=__codelineno-61-10 name=__codelineno-61-10></a><a href=#__codelineno-61-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-61-11 name=__codelineno-61-11></a><a href=#__codelineno-61-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-61-12 name=__codelineno-61-12></a><a href=#__codelineno-61-12><span class=linenos data-linenos="12 "></span></a>
<a id=__codelineno-61-13 name=__codelineno-61-13></a><a href=#__codelineno-61-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>retType_4_18</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>)()</span><span class=w> </span><span class=o>-&gt;</span><span class=w> </span><span class=kt>void</span><span class=p>;</span>
<a id=__codelineno-61-14 name=__codelineno-61-14></a><a href=#__codelineno-61-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=kr>inline</span><span class=w> </span><span class=k>operator</span><span class=w> </span><span class=n>retType_4_18</span><span class=w> </span><span class=p>()</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=k>noexcept</span>
<a id=__codelineno-61-15 name=__codelineno-61-15></a><a href=#__codelineno-61-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-61-16 name=__codelineno-61-16></a><a href=#__codelineno-61-16><span class=linenos data-linenos="16 "></span></a><span class=w>      </span><span class=k>return</span><span class=w> </span><span class=n>__invoke</span><span class=p>;</span>
<a id=__codelineno-61-17 name=__codelineno-61-17></a><a href=#__codelineno-61-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-61-18 name=__codelineno-61-18></a><a href=#__codelineno-61-18><span class=linenos data-linenos="18 "></span></a>
<a id=__codelineno-61-19 name=__codelineno-61-19></a><a href=#__codelineno-61-19><span class=linenos data-linenos="19 "></span></a><span class=w>    </span><span class=k>private</span><span class=o>:</span>
<a id=__codelineno-61-20 name=__codelineno-61-20></a><a href=#__codelineno-61-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=k>static</span><span class=w> </span><span class=kr>inline</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=n>__invoke</span><span class=p>()</span>
<a id=__codelineno-61-21 name=__codelineno-61-21></a><a href=#__codelineno-61-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=p>{</span>
<a id=__codelineno-61-22 name=__codelineno-61-22></a><a href=#__codelineno-61-22><span class=linenos data-linenos="22 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-61-23 name=__codelineno-61-23></a><a href=#__codelineno-61-23><span class=linenos data-linenos="23 "></span></a>
<a id=__codelineno-61-24 name=__codelineno-61-24></a><a href=#__codelineno-61-24><span class=linenos data-linenos="24 "></span></a>
<a id=__codelineno-61-25 name=__codelineno-61-25></a><a href=#__codelineno-61-25><span class=linenos data-linenos="25 "></span></a><span class=w>  </span><span class=p>}</span><span class=w> </span><span class=n>__lambda_4_18</span><span class=p>{};</span>
<a id=__codelineno-61-26 name=__codelineno-61-26></a><a href=#__codelineno-61-26><span class=linenos data-linenos="26 "></span></a>
<a id=__codelineno-61-27 name=__codelineno-61-27></a><a href=#__codelineno-61-27><span class=linenos data-linenos="27 "></span></a><span class=w>  </span><span class=k>using</span><span class=w> </span><span class=n>FuncPtr_4</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>)();</span>
<a id=__codelineno-61-28 name=__codelineno-61-28></a><a href=#__codelineno-61-28><span class=linenos data-linenos="28 "></span></a><span class=w>  </span><span class=n>FuncPtr_4</span><span class=w> </span><span class=n>funcPtr</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=o>+</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>void</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>)()</span><span class=o>&gt;</span><span class=p>(</span><span class=n>__lambda_4_18</span><span class=p>.</span><span class=k>operator</span><span class=w> </span><span class=n>__lambda_4_18</span><span class=o>::</span><span class=n>retType_4_18</span><span class=p>());</span>
<a id=__codelineno-61-29 name=__codelineno-61-29></a><a href=#__codelineno-61-29><span class=linenos data-linenos="29 "></span></a><span class=w>  </span><span class=cm>/* PASSED: static_assert(std::integral_constant&lt;bool, 1&gt;::value); */</span>
<a id=__codelineno-61-30 name=__codelineno-61-30></a><a href=#__codelineno-61-30><span class=linenos data-linenos="30 "></span></a><span class=p>}</span>
</code></pre></div> <p>代码中的 <code>+</code> 是一个一元运算符，且可以运用在指针上。</p> <p>因此编译器将无状态的 Lambda 转换成了函数指针，再分配给 <code>funcPtr</code>。</p> <p>另一方面，如果删除了“<code>+</code>”号，那么 <code>funcPtr</code> 就仅仅是一个单纯的闭包对象，所以在 <code>static_assert</code> 时会失败。</p> <p>虽然用 <code>+</code> 这样的语法可能不是一个最好的方式，但是你可以用 <code>static_cast</code> 来替代，可以实现和 <code>+</code> 一样的效果。</p> <p>当您不希望编译器创建太多函数实例时，您可以应用此技术。例如：</p> <blockquote> <p>代码 2-22 <a href=https://cppinsights.io/s/e4764e54>强制转换为函数调用</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-62-1 name=__codelineno-62-1></a><a href=#__codelineno-62-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>F</span><span class=o>&gt;</span>
<a id=__codelineno-62-2 name=__codelineno-62-2></a><a href=#__codelineno-62-2><span class=linenos data-linenos=" 2 "></span></a><span class=kt>void</span><span class=w> </span><span class=n>call_function</span><span class=p>(</span><span class=n>F</span><span class=w> </span><span class=n>f</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-62-3 name=__codelineno-62-3></a><a href=#__codelineno-62-3><span class=linenos data-linenos=" 3 "></span></a><span class=w>    </span><span class=n>f</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
<a id=__codelineno-62-4 name=__codelineno-62-4></a><a href=#__codelineno-62-4><span class=linenos data-linenos=" 4 "></span></a><span class=p>}</span>
<a id=__codelineno-62-5 name=__codelineno-62-5></a><a href=#__codelineno-62-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-62-6 name=__codelineno-62-6></a><a href=#__codelineno-62-6><span class=linenos data-linenos=" 6 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-62-7 name=__codelineno-62-7></a><a href=#__codelineno-62-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=n>call_function</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>int</span><span class=p>)</span><span class=o>&gt;</span><span class=p>([](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-62-8 name=__codelineno-62-8></a><a href=#__codelineno-62-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-62-9 name=__codelineno-62-9></a><a href=#__codelineno-62-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>}));</span>
<a id=__codelineno-62-10 name=__codelineno-62-10></a><a href=#__codelineno-62-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=n>call_function</span><span class=p>(</span><span class=k>static_cast</span><span class=o>&lt;</span><span class=kt>int</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>int</span><span class=p>)</span><span class=o>&gt;</span><span class=p>([](</span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-62-11 name=__codelineno-62-11></a><a href=#__codelineno-62-11><span class=linenos data-linenos="11 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>*</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-62-12 name=__codelineno-62-12></a><a href=#__codelineno-62-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=p>}));</span>
<a id=__codelineno-62-13 name=__codelineno-62-13></a><a href=#__codelineno-62-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
</code></pre></div> <p>在上面的例子中，编译器只需要创建一个 <code>call_function</code> 实例，因为它只需要一个函数指针 <code>int (*)(int)</code>。</p> <p>但是如果你删除 <code>static_casts</code> 那么你将得到两个版本的 <code>call_function</code> 因为编译器必须为 Lambdas 创建两个单独的类型。</p> <h2 id=7-iife---立即调用函数表达式>7. IIFE - 立即调用函数表达式<a class=headerlink href=#7-iife---立即调用函数表达式 title="Permanent link"></a></h2> <p>在多数例子中，你可能发现了，我经常都是先定义好 Lambda，在之后才去调用它。</p> <p>然而，你也可以直接立即调用一个 lambda：</p> <blockquote> <p>代码 2-23 <a href=https://wandbox.org/permlink/fsFOxzBZuFS7bMVn>“现写现用”Lambda</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-63-1 name=__codelineno-63-1></a><a href=#__codelineno-63-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-63-2 name=__codelineno-63-2></a><a href=#__codelineno-63-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-63-3 name=__codelineno-63-3></a><a href=#__codelineno-63-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-63-4 name=__codelineno-63-4></a><a href=#__codelineno-63-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>,</span><span class=w> </span><span class=n>y</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>1</span><span class=p>;</span>
<a id=__codelineno-63-5 name=__codelineno-63-5></a><a href=#__codelineno-63-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-63-6 name=__codelineno-63-6></a><a href=#__codelineno-63-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=p>[</span><span class=o>&amp;</span><span class=p>]()</span><span class=w> </span><span class=k>noexcept</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-63-7 name=__codelineno-63-7></a><a href=#__codelineno-63-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>x</span><span class=p>;</span>
<a id=__codelineno-63-8 name=__codelineno-63-8></a><a href=#__codelineno-63-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=o>++</span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-63-9 name=__codelineno-63-9></a><a href=#__codelineno-63-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=p>}();</span><span class=w>  </span><span class=c1>// &lt;-- call ()</span>
<a id=__codelineno-63-10 name=__codelineno-63-10></a><a href=#__codelineno-63-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-63-11 name=__codelineno-63-11></a><a href=#__codelineno-63-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;, &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>y</span><span class=p>;</span>
<a id=__codelineno-63-12 name=__codelineno-63-12></a><a href=#__codelineno-63-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
</code></pre></div> <p>上面这个例子，Lambda 在被创建之后没有赋给任何一个闭包对象，而是直接被调用（通过“<code>()</code>”操作符）。</p> <p>如果你运行上述程序，期望结果应该是输出了：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-64-1 name=__codelineno-64-1></a><a href=#__codelineno-64-1><span class=linenos data-linenos="1 "></span></a>2, 2
</code></pre></div> <p>在遇到复杂的常量对象的初始化时，这种表达式将十分地有用：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-65-1 name=__codelineno-65-1></a><a href=#__codelineno-65-1><span class=linenos data-linenos="1 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>val</span><span class=w> </span><span class=o>=</span><span class=p>[]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-65-2 name=__codelineno-65-2></a><a href=#__codelineno-65-2><span class=linenos data-linenos="2 "></span></a><span class=w>    </span><span class=cm>/* several lines of code... */</span>
<a id=__codelineno-65-3 name=__codelineno-65-3></a><a href=#__codelineno-65-3><span class=linenos data-linenos="3 "></span></a><span class=p>}();</span><span class=w> </span><span class=c1>// call it!</span>
</code></pre></div> <p>其中，<code>val</code> 是一个常量（constant value），并且其类型为 Lambda 表达式的返回类型：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-66-1 name=__codelineno-66-1></a><a href=#__codelineno-66-1><span class=linenos data-linenos="1 "></span></a><span class=c1>// val1 is int</span>
<a id=__codelineno-66-2 name=__codelineno-66-2></a><a href=#__codelineno-66-2><span class=linenos data-linenos="2 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>val1</span><span class=w> </span><span class=o>=</span><span class=p>[]()</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=mi>10</span><span class=p>;</span><span class=w> </span><span class=p>}();</span>
<a id=__codelineno-66-3 name=__codelineno-66-3></a><a href=#__codelineno-66-3><span class=linenos data-linenos="3 "></span></a><span class=c1>// val2 is std::string</span>
<a id=__codelineno-66-4 name=__codelineno-66-4></a><a href=#__codelineno-66-4><span class=linenos data-linenos="4 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>val2</span><span class=w> </span><span class=o>=</span><span class=p>[]()</span><span class=w> </span><span class=o>-&gt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=s>&quot;ABC&quot;</span><span class=p>;</span><span class=w> </span><span class=p>}();</span>
</code></pre></div> <p>下面我们来看一个较长的用例，在函数内部使用 IIFE 形式来构造一个辅助 Lambda 函数，去创建一个常量。</p> <blockquote> <p>代码 2-24 <a href=https://wandbox.org/permlink/TtlM1t3sm9EZOUrw>IIFE 和 HTML 生成器</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-67-1 name=__codelineno-67-1></a><a href=#__codelineno-67-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-67-2 name=__codelineno-67-2></a><a href=#__codelineno-67-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;string&gt;</span>
<a id=__codelineno-67-3 name=__codelineno-67-3></a><a href=#__codelineno-67-3><span class=linenos data-linenos=" 3 "></span></a>
<a id=__codelineno-67-4 name=__codelineno-67-4></a><a href=#__codelineno-67-4><span class=linenos data-linenos=" 4 "></span></a><span class=kt>void</span><span class=w> </span><span class=nf>ValidateHTML</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-67-5 name=__codelineno-67-5></a><a href=#__codelineno-67-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-67-6 name=__codelineno-67-6></a><a href=#__codelineno-67-6><span class=linenos data-linenos=" 6 "></span></a><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=nf>BuildAHref</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>text</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-67-7 name=__codelineno-67-7></a><a href=#__codelineno-67-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>html</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>link</span><span class=p>,</span><span class=w> </span><span class=o>&amp;</span><span class=n>text</span><span class=p>]</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-67-8 name=__codelineno-67-8></a><a href=#__codelineno-67-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>        </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>inText</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>text</span><span class=p>.</span><span class=n>empty</span><span class=p>()</span><span class=w> </span><span class=o>?</span><span class=w> </span><span class=n>link</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>text</span><span class=p>;</span>
<a id=__codelineno-67-9 name=__codelineno-67-9></a><a href=#__codelineno-67-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=s>&quot;&lt;a href=</span><span class=se>\&quot;</span><span class=s>&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>link</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;</span><span class=se>\&quot;</span><span class=s>&gt;&quot;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>inText</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot;&lt;/a&gt;&quot;</span><span class=p>;</span>
<a id=__codelineno-67-10 name=__codelineno-67-10></a><a href=#__codelineno-67-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=p>}();</span><span class=w>  </span><span class=c1>// call!</span>
<a id=__codelineno-67-11 name=__codelineno-67-11></a><a href=#__codelineno-67-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=n>ValidateHTML</span><span class=p>(</span><span class=n>html</span><span class=p>);</span>
<a id=__codelineno-67-12 name=__codelineno-67-12></a><a href=#__codelineno-67-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>html</span><span class=p>;</span>
<a id=__codelineno-67-13 name=__codelineno-67-13></a><a href=#__codelineno-67-13><span class=linenos data-linenos="13 "></span></a><span class=p>}</span>
<a id=__codelineno-67-14 name=__codelineno-67-14></a><a href=#__codelineno-67-14><span class=linenos data-linenos="14 "></span></a>
<a id=__codelineno-67-15 name=__codelineno-67-15></a><a href=#__codelineno-67-15><span class=linenos data-linenos="15 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-67-16 name=__codelineno-67-16></a><a href=#__codelineno-67-16><span class=linenos data-linenos="16 "></span></a><span class=w>    </span><span class=k>try</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-67-17 name=__codelineno-67-17></a><a href=#__codelineno-67-17><span class=linenos data-linenos="17 "></span></a><span class=w>        </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>ahref</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BuildAHref</span><span class=p>(</span><span class=s>&quot;www.leanpub.com&quot;</span><span class=p>,</span><span class=w> </span><span class=s>&quot;Leanpub Store&quot;</span><span class=p>);</span>
<a id=__codelineno-67-18 name=__codelineno-67-18></a><a href=#__codelineno-67-18><span class=linenos data-linenos="18 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>ahref</span><span class=p>;</span>
<a id=__codelineno-67-19 name=__codelineno-67-19></a><a href=#__codelineno-67-19><span class=linenos data-linenos="19 "></span></a><span class=w>    </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(...)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-67-20 name=__codelineno-67-20></a><a href=#__codelineno-67-20><span class=linenos data-linenos="20 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;bad format...&quot;</span><span class=p>;</span>
<a id=__codelineno-67-21 name=__codelineno-67-21></a><a href=#__codelineno-67-21><span class=linenos data-linenos="21 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-67-22 name=__codelineno-67-22></a><a href=#__codelineno-67-22><span class=linenos data-linenos="22 "></span></a><span class=p>}</span>
</code></pre></div> <p>这个用例中，函数 <code>BuildAHref()</code>，它接受两个参数，然后构建一个 <code>&lt;a&gt; &lt;/a&gt;</code> HTML 标签。</p> <p>根据输入参数，我们构建 <code>html</code> 变量。</p> <p>如果文本不为空，则我们将其用作内部 HTML 值。</p> <p>否则，我们使用默认链接。</p> <p>我们希望 html 变量是常量，但很难编写具有输入参数所需条件的紧凑代码。</p> <p>多亏了 IIFE，我们可以编写单独的 Lambda，然后用 <code>const</code> 标记我们的变量。</p> <p>稍后可以将变量传递给 <code>ValidateHTML</code>。</p> <h3 id=可读性提示>可读性提示<a class=headerlink href=#可读性提示 title="Permanent link"></a></h3> <p>有些时候，利用现写现用的 Lambda 表达式会造成一些代码可读性上的困扰。</p> <p>例如：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-68-1 name=__codelineno-68-1></a><a href=#__codelineno-68-1><span class=linenos data-linenos=" 1 "></span></a><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>EnableErrorReporting</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=p>]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-68-2 name=__codelineno-68-2></a><a href=#__codelineno-68-2><span class=linenos data-linenos=" 2 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>HighLevelWarningEnabled</span><span class=p>())</span>
<a id=__codelineno-68-3 name=__codelineno-68-3></a><a href=#__codelineno-68-3><span class=linenos data-linenos=" 3 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=nb>true</span><span class=p>;</span>
<a id=__codelineno-68-4 name=__codelineno-68-4></a><a href=#__codelineno-68-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>HighLevelWarningEnabled</span><span class=p>())</span>
<a id=__codelineno-68-5 name=__codelineno-68-5></a><a href=#__codelineno-68-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>UsersWantReporting</span><span class=p>();</span>
<a id=__codelineno-68-6 name=__codelineno-68-6></a><a href=#__codelineno-68-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=nb>false</span><span class=p>;</span>
<a id=__codelineno-68-7 name=__codelineno-68-7></a><a href=#__codelineno-68-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>}();</span>
<a id=__codelineno-68-8 name=__codelineno-68-8></a><a href=#__codelineno-68-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-68-9 name=__codelineno-68-9></a><a href=#__codelineno-68-9><span class=linenos data-linenos=" 9 "></span></a><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>EnableErrorReporting</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-68-10 name=__codelineno-68-10></a><a href=#__codelineno-68-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=c1>// ...</span>
<a id=__codelineno-68-11 name=__codelineno-68-11></a><a href=#__codelineno-68-11><span class=linenos data-linenos="11 "></span></a><span class=p>}</span>
</code></pre></div> <p>在上面的例子中，Lambda 代码相当复杂，阅读代码的开发人员不仅要解密 Lambda 是立即调用的，而且还要对 <code>EnableErrorReporting</code> 类型进行推理。</p> <p>他们可能会假设 <code>EnableErrorReporting</code> 是闭包对象而不仅仅是一个常量变量。</p> <p>对于这种情况，您可能会考虑不使用 <code>auto</code>，以便我们可以轻松查看类型。</p> <p>甚至可以在 <code>}()</code> 旁边添加注释，例如 <code>// call it now</code>。</p> <blockquote> <p>在 C++17 章节我们会遇到一个“升级版”的 IIFE。</p> </blockquote> <h2 id=8-lambda-继承>8. Lambda 继承<a class=headerlink href=#8-lambda-继承 title="Permanent link"></a></h2> <p>也许你会有些吃惊，Lambda 居然还可以派生？</p> <p>由于编译器将 Lambda 扩展为了一个仿函数对象，并重载了其调用操作符 <code>()</code>，所以我们可以从这点去继承 Lambda。</p> <p>来看看一个基础代码：</p> <blockquote> <p>代码 2-25 <a href=https://wandbox.org/permlink/uA4q7Zy1kojUZmqb>从单个 Lambda 中继承</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-69-1 name=__codelineno-69-1></a><a href=#__codelineno-69-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-69-2 name=__codelineno-69-2></a><a href=#__codelineno-69-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-69-3 name=__codelineno-69-3></a><a href=#__codelineno-69-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>Callable</span><span class=o>&gt;</span>
<a id=__codelineno-69-4 name=__codelineno-69-4></a><a href=#__codelineno-69-4><span class=linenos data-linenos=" 4 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>ComplexFunctor</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>Callable</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-69-5 name=__codelineno-69-5></a><a href=#__codelineno-69-5><span class=linenos data-linenos=" 5 "></span></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-69-6 name=__codelineno-69-6></a><a href=#__codelineno-69-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=k>explicit</span><span class=w> </span><span class=n>ComplexFunctor</span><span class=p>(</span><span class=n>Callable</span><span class=w> </span><span class=n>f</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>Callable</span><span class=p>(</span><span class=n>f</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-69-7 name=__codelineno-69-7></a><a href=#__codelineno-69-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>};</span>
<a id=__codelineno-69-8 name=__codelineno-69-8></a><a href=#__codelineno-69-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-69-9 name=__codelineno-69-9></a><a href=#__codelineno-69-9><span class=linenos data-linenos=" 9 "></span></a><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>Callable</span><span class=o>&gt;</span>
<a id=__codelineno-69-10 name=__codelineno-69-10></a><a href=#__codelineno-69-10><span class=linenos data-linenos="10 "></span></a><span class=n>ComplexFunctor</span><span class=o>&lt;</span><span class=n>Callable</span><span class=o>&gt;</span><span class=w> </span><span class=n>MakeComplexFunctor</span><span class=p>(</span><span class=n>Callable</span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>cal</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-69-11 name=__codelineno-69-11></a><a href=#__codelineno-69-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>ComplexFunctor</span><span class=o>&lt;</span><span class=n>Callable</span><span class=o>&gt;</span><span class=p>(</span><span class=n>cal</span><span class=p>);</span>
<a id=__codelineno-69-12 name=__codelineno-69-12></a><a href=#__codelineno-69-12><span class=linenos data-linenos="12 "></span></a><span class=p>}</span>
<a id=__codelineno-69-13 name=__codelineno-69-13></a><a href=#__codelineno-69-13><span class=linenos data-linenos="13 "></span></a>
<a id=__codelineno-69-14 name=__codelineno-69-14></a><a href=#__codelineno-69-14><span class=linenos data-linenos="14 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-69-15 name=__codelineno-69-15></a><a href=#__codelineno-69-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>func</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MakeComplexFunctor</span><span class=p>([]()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-69-16 name=__codelineno-69-16></a><a href=#__codelineno-69-16><span class=linenos data-linenos="16 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Hello Functor!&quot;</span><span class=p>;</span>
<a id=__codelineno-69-17 name=__codelineno-69-17></a><a href=#__codelineno-69-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=p>});</span>
<a id=__codelineno-69-18 name=__codelineno-69-18></a><a href=#__codelineno-69-18><span class=linenos data-linenos="18 "></span></a><span class=w>    </span><span class=n>func</span><span class=p>();</span>
<a id=__codelineno-69-19 name=__codelineno-69-19></a><a href=#__codelineno-69-19><span class=linenos data-linenos="19 "></span></a><span class=p>}</span>
</code></pre></div> <p>这段代码中，有一个 <code>ComplexFunctor</code> 类，它派生自 <code>Callable</code>，它是一个模板参数。如果我们想从 Lambda 派生，我们需要做一个小技巧，因为我们无法拼出闭包类型的确切类型（除非我们将它包装到 <code>std::function</code> 中）。</p> <p>这就是为什么我们需要可以执行模板参数推导并获取 Lambda 闭包类型的 <code>MakeComplexFunctor</code> 函数。</p> <p>除了名称之外，<code>ComplexFunctor</code> 只是一个简单的包装器，没有多大用处。是否有此类代码模式的用例。</p> <p>例如，我们可以扩展上面的代码并继承两个 Lambdas 并创建一个重载集：</p> <blockquote> <p>代码 2-25 <a href=https://wandbox.org/permlink/2AY4nRaHffrDWt6A>从两个 Lambda 中继承</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-70-1 name=__codelineno-70-1></a><a href=#__codelineno-70-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-70-2 name=__codelineno-70-2></a><a href=#__codelineno-70-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-70-3 name=__codelineno-70-3></a><a href=#__codelineno-70-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>TCall</span><span class=p>,</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>UCall</span><span class=o>&gt;</span>
<a id=__codelineno-70-4 name=__codelineno-70-4></a><a href=#__codelineno-70-4><span class=linenos data-linenos=" 4 "></span></a><span class=k>class</span><span class=w> </span><span class=nc>SimpleOverloaded</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>TCall</span><span class=p>,</span><span class=w> </span><span class=n>UCall</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-70-5 name=__codelineno-70-5></a><a href=#__codelineno-70-5><span class=linenos data-linenos=" 5 "></span></a><span class=k>public</span><span class=o>:</span>
<a id=__codelineno-70-6 name=__codelineno-70-6></a><a href=#__codelineno-70-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=n>SimpleOverloaded</span><span class=p>(</span><span class=n>TCall</span><span class=w> </span><span class=n>tf</span><span class=p>,</span><span class=w> </span><span class=n>UCall</span><span class=w> </span><span class=n>uf</span><span class=p>)</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>TCall</span><span class=p>(</span><span class=n>tf</span><span class=p>),</span><span class=w> </span><span class=n>UCall</span><span class=p>(</span><span class=n>uf</span><span class=p>)</span><span class=w> </span><span class=p>{}</span>
<a id=__codelineno-70-7 name=__codelineno-70-7></a><a href=#__codelineno-70-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>TCall</span><span class=o>::</span><span class=k>operator</span><span class=p>();</span>
<a id=__codelineno-70-8 name=__codelineno-70-8></a><a href=#__codelineno-70-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>UCall</span><span class=o>::</span><span class=k>operator</span><span class=p>();</span>
<a id=__codelineno-70-9 name=__codelineno-70-9></a><a href=#__codelineno-70-9><span class=linenos data-linenos=" 9 "></span></a><span class=p>};</span>
<a id=__codelineno-70-10 name=__codelineno-70-10></a><a href=#__codelineno-70-10><span class=linenos data-linenos="10 "></span></a>
<a id=__codelineno-70-11 name=__codelineno-70-11></a><a href=#__codelineno-70-11><span class=linenos data-linenos="11 "></span></a><span class=k>template</span><span class=w> </span><span class=o>&lt;</span><span class=k>typename</span><span class=w> </span><span class=nc>TCall</span><span class=p>,</span><span class=w> </span><span class=k>typename</span><span class=w> </span><span class=nc>UCall</span><span class=o>&gt;</span>
<a id=__codelineno-70-12 name=__codelineno-70-12></a><a href=#__codelineno-70-12><span class=linenos data-linenos="12 "></span></a><span class=n>SimpleOverloaded</span><span class=o>&lt;</span><span class=n>TCall</span><span class=p>,</span><span class=w> </span><span class=n>UCall</span><span class=o>&gt;</span><span class=w> </span><span class=n>MakeOverloaded</span><span class=p>(</span><span class=n>TCall</span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>tf</span><span class=p>,</span><span class=w> </span><span class=n>UCall</span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>uf</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-70-13 name=__codelineno-70-13></a><a href=#__codelineno-70-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=k>return</span><span class=w> </span><span class=n>SimpleOverloaded</span><span class=o>&lt;</span><span class=n>TCall</span><span class=p>,</span><span class=w> </span><span class=n>UCall</span><span class=o>&gt;</span><span class=p>(</span><span class=n>tf</span><span class=p>,</span><span class=w> </span><span class=n>uf</span><span class=p>);</span>
<a id=__codelineno-70-14 name=__codelineno-70-14></a><a href=#__codelineno-70-14><span class=linenos data-linenos="14 "></span></a><span class=p>}</span>
<a id=__codelineno-70-15 name=__codelineno-70-15></a><a href=#__codelineno-70-15><span class=linenos data-linenos="15 "></span></a>
<a id=__codelineno-70-16 name=__codelineno-70-16></a><a href=#__codelineno-70-16><span class=linenos data-linenos="16 "></span></a><span class=kt>int</span><span class=w> </span><span class=n>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-70-17 name=__codelineno-70-17></a><a href=#__codelineno-70-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>func</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>MakeOverloaded</span><span class=p>(</span>
<a id=__codelineno-70-18 name=__codelineno-70-18></a><a href=#__codelineno-70-18><span class=linenos data-linenos="18 "></span></a><span class=w>            </span><span class=p>[](</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-70-19 name=__codelineno-70-19></a><a href=#__codelineno-70-19><span class=linenos data-linenos="19 "></span></a><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Int!</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>;</span>
<a id=__codelineno-70-20 name=__codelineno-70-20></a><a href=#__codelineno-70-20><span class=linenos data-linenos="20 "></span></a><span class=w>            </span><span class=p>},</span>
<a id=__codelineno-70-21 name=__codelineno-70-21></a><a href=#__codelineno-70-21><span class=linenos data-linenos="21 "></span></a><span class=w>            </span><span class=p>[](</span><span class=kt>float</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-70-22 name=__codelineno-70-22></a><a href=#__codelineno-70-22><span class=linenos data-linenos="22 "></span></a><span class=w>                </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;Float!</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>;</span>
<a id=__codelineno-70-23 name=__codelineno-70-23></a><a href=#__codelineno-70-23><span class=linenos data-linenos="23 "></span></a><span class=w>            </span><span class=p>});</span>
<a id=__codelineno-70-24 name=__codelineno-70-24></a><a href=#__codelineno-70-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class=n>func</span><span class=p>(</span><span class=mi>10</span><span class=p>);</span>
<a id=__codelineno-70-25 name=__codelineno-70-25></a><a href=#__codelineno-70-25><span class=linenos data-linenos="25 "></span></a><span class=w>    </span><span class=n>func</span><span class=p>(</span><span class=mf>10.0f</span><span class=p>);</span>
<a id=__codelineno-70-26 name=__codelineno-70-26></a><a href=#__codelineno-70-26><span class=linenos data-linenos="26 "></span></a><span class=p>}</span>
</code></pre></div> <p>这次我们有更多的代码：我们从两个模板参数派生，但我们还需要显式地公开它们的调用运算符。</p> <p>这是为什么呢？这是因为在寻找正确的函数重载时，编译器要求候选对象在同一范围内。</p> <p>为了理解这一点，让我们编写一个派生自两个基类的简单类型。</p> <p>该示例还注释掉了两个 <code>using</code> 语句。</p> <div class=highlight><pre><span></span><code><a id=__codelineno-71-1 name=__codelineno-71-1></a><a href=#__codelineno-71-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-71-2 name=__codelineno-71-2></a><a href=#__codelineno-71-2><span class=linenos data-linenos=" 2 "></span></a>
<a id=__codelineno-71-3 name=__codelineno-71-3></a><a href=#__codelineno-71-3><span class=linenos data-linenos=" 3 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>BaseInt</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-71-4 name=__codelineno-71-4></a><a href=#__codelineno-71-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>Func</span><span class=p>(</span><span class=kt>int</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-71-5 name=__codelineno-71-5></a><a href=#__codelineno-71-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;BaseInt...</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>;</span>
<a id=__codelineno-71-6 name=__codelineno-71-6></a><a href=#__codelineno-71-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-71-7 name=__codelineno-71-7></a><a href=#__codelineno-71-7><span class=linenos data-linenos=" 7 "></span></a><span class=p>};</span>
<a id=__codelineno-71-8 name=__codelineno-71-8></a><a href=#__codelineno-71-8><span class=linenos data-linenos=" 8 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>BaseDouble</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-71-9 name=__codelineno-71-9></a><a href=#__codelineno-71-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>Func</span><span class=p>(</span><span class=kt>double</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-71-10 name=__codelineno-71-10></a><a href=#__codelineno-71-10><span class=linenos data-linenos="10 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=s>&quot;BaseDouble...</span><span class=se>\n</span><span class=s>&quot;</span><span class=p>;</span>
<a id=__codelineno-71-11 name=__codelineno-71-11></a><a href=#__codelineno-71-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=p>}</span>
<a id=__codelineno-71-12 name=__codelineno-71-12></a><a href=#__codelineno-71-12><span class=linenos data-linenos="12 "></span></a><span class=p>};</span>
<a id=__codelineno-71-13 name=__codelineno-71-13></a><a href=#__codelineno-71-13><span class=linenos data-linenos="13 "></span></a><span class=k>struct</span><span class=w> </span><span class=nc>Derived</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=k>public</span><span class=w> </span><span class=n>BaseInt</span><span class=p>,</span><span class=w> </span><span class=n>BaseDouble</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-71-14 name=__codelineno-71-14></a><a href=#__codelineno-71-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=c1>// using BaseInt::Func;</span>
<a id=__codelineno-71-15 name=__codelineno-71-15></a><a href=#__codelineno-71-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=c1>// using BaseDouble::Func;</span>
<a id=__codelineno-71-16 name=__codelineno-71-16></a><a href=#__codelineno-71-16><span class=linenos data-linenos="16 "></span></a><span class=p>};</span>
<a id=__codelineno-71-17 name=__codelineno-71-17></a><a href=#__codelineno-71-17><span class=linenos data-linenos="17 "></span></a>
<a id=__codelineno-71-18 name=__codelineno-71-18></a><a href=#__codelineno-71-18><span class=linenos data-linenos="18 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-71-19 name=__codelineno-71-19></a><a href=#__codelineno-71-19><span class=linenos data-linenos="19 "></span></a><span class=w>    </span><span class=n>Derived</span><span class=w> </span><span class=n>d</span><span class=p>;</span>
<a id=__codelineno-71-20 name=__codelineno-71-20></a><a href=#__codelineno-71-20><span class=linenos data-linenos="20 "></span></a><span class=w>    </span><span class=n>d</span><span class=p>.</span><span class=n>Func</span><span class=p>(</span><span class=mf>10.0</span><span class=p>);</span>
<a id=__codelineno-71-21 name=__codelineno-71-21></a><a href=#__codelineno-71-21><span class=linenos data-linenos="21 "></span></a><span class=p>}</span>
</code></pre></div> <p>我们有两个实现 <code>Func</code> 的基类。我们想从派生对象调用这个 <code>Func</code> 方法。</p> <p><a href=https://wandbox.org/permlink/fFRqVGUisdQh1qGV>GCC</a> 编译便会报出错误：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-72-1 name=__codelineno-72-1></a><a href=#__codelineno-72-1><span class=linenos data-linenos="1 "></span></a>error:request formember &#39;Func&#39; is ambiguous
</code></pre></div> <p>因为我们注释掉了全部的声明来自 <code>BaseInt</code> 和 <code>BaseDouble</code> 的 <code>::Func</code> 的 <code>using</code> 语句。</p> <p>编译器有两个作用域来搜索最佳候选，根据标准，这是不允许的。</p> <p>好吧，让我们回到我们的更上面那个例子：<code>SimpleOverloaded</code> 是一个基本类，它不是生产就绪的。</p> <p>看看 C++17 章，我们将讨论此模式的高级版本。</p> <p>多亏了 C++17 的几个特性，我们将能够从多个 Lambda 继承（感谢可变参数模板）并利用更多的紧凑语法！</p> <h2 id=9-在容器中存储-lambda>9. 在容器中存储 Lambda<a class=headerlink href=#9-在容器中存储-lambda title="Permanent link"></a></h2> <p>作为本章的最后一个技巧，让我们来看看在容器中存储闭包的问题。</p> <p>但是我不是写过不能默认创建和分配 Lambdas 吗？</p> <p>是的……但是我们可以在这里做一些技巧。</p> <p>技术之一是利用转换为函数指针的无状态 Lambda 的属性。</p> <p>虽然您不能直接存储闭包对象，但您可以保存从 Lambda 表达式转换而来的函数指针。</p> <p>例如：</p> <blockquote> <p>代码 2-26 <a href=https://wandbox.org/permlink/CuoCtCHEEk6ZA6xF>将 Lambda 存为函数指针</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-73-1 name=__codelineno-73-1></a><a href=#__codelineno-73-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-73-2 name=__codelineno-73-2></a><a href=#__codelineno-73-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
<a id=__codelineno-73-3 name=__codelineno-73-3></a><a href=#__codelineno-73-3><span class=linenos data-linenos=" 3 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-73-4 name=__codelineno-73-4></a><a href=#__codelineno-73-4><span class=linenos data-linenos=" 4 "></span></a><span class=w>    </span><span class=k>using</span><span class=w> </span><span class=n>TFunc</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=p>(</span><span class=o>*</span><span class=p>)(</span><span class=kt>int</span><span class=o>&amp;</span><span class=p>);</span>
<a id=__codelineno-73-5 name=__codelineno-73-5></a><a href=#__codelineno-73-5><span class=linenos data-linenos=" 5 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>TFunc</span><span class=o>&gt;</span><span class=w> </span><span class=n>ptrFuncVec</span><span class=p>;</span>
<a id=__codelineno-73-6 name=__codelineno-73-6></a><a href=#__codelineno-73-6><span class=linenos data-linenos=" 6 "></span></a><span class=w>    </span><span class=n>ptrFuncVec</span><span class=p>.</span><span class=n>push_back</span><span class=p>([](</span><span class=kt>int</span><span class=o>&amp;</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-73-7 name=__codelineno-73-7></a><a href=#__codelineno-73-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-73-8 name=__codelineno-73-8></a><a href=#__codelineno-73-8><span class=linenos data-linenos=" 8 "></span></a><span class=w>    </span><span class=p>});</span>
<a id=__codelineno-73-9 name=__codelineno-73-9></a><a href=#__codelineno-73-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=n>ptrFuncVec</span><span class=p>.</span><span class=n>push_back</span><span class=p>([](</span><span class=kt>int</span><span class=o>&amp;</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-73-10 name=__codelineno-73-10></a><a href=#__codelineno-73-10><span class=linenos data-linenos="10 "></span></a><span class=w>        </span><span class=n>x</span><span class=w> </span><span class=o>*=</span><span class=w> </span><span class=mi>2</span><span class=p>;</span>
<a id=__codelineno-73-11 name=__codelineno-73-11></a><a href=#__codelineno-73-11><span class=linenos data-linenos="11 "></span></a><span class=w>    </span><span class=p>});</span>
<a id=__codelineno-73-12 name=__codelineno-73-12></a><a href=#__codelineno-73-12><span class=linenos data-linenos="12 "></span></a><span class=w>    </span><span class=n>ptrFuncVec</span><span class=p>.</span><span class=n>push_back</span><span class=p>(</span><span class=n>ptrFuncVec</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span><span class=w>  </span><span class=c1>// print it again;</span>
<a id=__codelineno-73-13 name=__codelineno-73-13></a><a href=#__codelineno-73-13><span class=linenos data-linenos="13 "></span></a><span class=w>    </span><span class=kt>int</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>10</span><span class=p>;</span>
<a id=__codelineno-73-14 name=__codelineno-73-14></a><a href=#__codelineno-73-14><span class=linenos data-linenos="14 "></span></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=o>&amp;</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>ptrFuncVec</span><span class=p>)</span><span class=w> </span><span class=n>entry</span><span class=p>(</span><span class=n>x</span><span class=p>);</span>
<a id=__codelineno-73-15 name=__codelineno-73-15></a><a href=#__codelineno-73-15><span class=linenos data-linenos="15 "></span></a><span class=p>}</span>
</code></pre></div> <p>在上面的例子中，我们创建了一个将应用于变量的函数向量。容器中有三个条目：</p> <ul> <li>第一个打印输入参数的值。</li> <li>第二个修改值。</li> <li>第三个是第一个的副本，因此它也打印值。</li> </ul> <p>该解决方案有效，但仅限于无状态 Lambda。</p> <p>如果我们想解除这个限制怎么办？</p> <p>为了解决这个问题，我们可以使用重度助手：<code>std::function</code>。</p> <p>为了使示例有趣，它还从简单的整数切换到处理 <code>std::string objects</code> 的 Lambdas：</p> <blockquote> <p>代码 2-27 <a href=https://wandbox.org/permlink/XSK4ATo5HriOB6Gk>将 Lambda 存为 std::function</a></p> </blockquote> <div class=highlight><pre><span></span><code><a id=__codelineno-74-1 name=__codelineno-74-1></a><a href=#__codelineno-74-1><span class=linenos data-linenos=" 1 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;algorithm&gt;</span>
<a id=__codelineno-74-2 name=__codelineno-74-2></a><a href=#__codelineno-74-2><span class=linenos data-linenos=" 2 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;functional&gt;</span>
<a id=__codelineno-74-3 name=__codelineno-74-3></a><a href=#__codelineno-74-3><span class=linenos data-linenos=" 3 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;iostream&gt;</span>
<a id=__codelineno-74-4 name=__codelineno-74-4></a><a href=#__codelineno-74-4><span class=linenos data-linenos=" 4 "></span></a><span class=cp>#include</span><span class=w> </span><span class=cpf>&lt;vector&gt;</span>
<a id=__codelineno-74-5 name=__codelineno-74-5></a><a href=#__codelineno-74-5><span class=linenos data-linenos=" 5 "></span></a>
<a id=__codelineno-74-6 name=__codelineno-74-6></a><a href=#__codelineno-74-6><span class=linenos data-linenos=" 6 "></span></a><span class=kt>int</span><span class=w> </span><span class=nf>main</span><span class=p>()</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-74-7 name=__codelineno-74-7></a><a href=#__codelineno-74-7><span class=linenos data-linenos=" 7 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>vector</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>function</span><span class=o>&lt;</span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=p>)</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=n>vecFilters</span><span class=p>;</span>
<a id=__codelineno-74-8 name=__codelineno-74-8></a><a href=#__codelineno-74-8><span class=linenos data-linenos=" 8 "></span></a>
<a id=__codelineno-74-9 name=__codelineno-74-9></a><a href=#__codelineno-74-9><span class=linenos data-linenos=" 9 "></span></a><span class=w>    </span><span class=kt>size_t</span><span class=w> </span><span class=n>removedSpaceCounter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=mi>0</span><span class=p>;</span>
<a id=__codelineno-74-10 name=__codelineno-74-10></a><a href=#__codelineno-74-10><span class=linenos data-linenos="10 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>removeSpacesCnt</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[</span><span class=o>&amp;</span><span class=n>removedSpaceCounter</span><span class=p>](</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-74-11 name=__codelineno-74-11></a><a href=#__codelineno-74-11><span class=linenos data-linenos="11 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>tmp</span><span class=p>;</span>
<a id=__codelineno-74-12 name=__codelineno-74-12></a><a href=#__codelineno-74-12><span class=linenos data-linenos="12 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>copy_if</span><span class=p>(</span><span class=n>str</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>back_inserter</span><span class=p>(</span><span class=n>tmp</span><span class=p>),</span><span class=w> </span><span class=p>[](</span><span class=kt>char</span><span class=w> </span><span class=n>ch</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=k>return</span><span class=w> </span><span class=o>!</span><span class=n>isspace</span><span class=p>(</span><span class=n>ch</span><span class=p>);</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-74-13 name=__codelineno-74-13></a><a href=#__codelineno-74-13><span class=linenos data-linenos="13 "></span></a><span class=w>        </span><span class=n>removedSpaceCounter</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>str</span><span class=p>.</span><span class=n>length</span><span class=p>()</span><span class=w> </span><span class=o>-</span><span class=w> </span><span class=n>tmp</span><span class=p>.</span><span class=n>length</span><span class=p>();</span>
<a id=__codelineno-74-14 name=__codelineno-74-14></a><a href=#__codelineno-74-14><span class=linenos data-linenos="14 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>tmp</span><span class=p>;</span>
<a id=__codelineno-74-15 name=__codelineno-74-15></a><a href=#__codelineno-74-15><span class=linenos data-linenos="15 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-74-16 name=__codelineno-74-16></a><a href=#__codelineno-74-16><span class=linenos data-linenos="16 "></span></a>
<a id=__codelineno-74-17 name=__codelineno-74-17></a><a href=#__codelineno-74-17><span class=linenos data-linenos="17 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=n>makeUpperCase</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>[](</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>str</span><span class=p>)</span><span class=w> </span><span class=p>{</span>
<a id=__codelineno-74-18 name=__codelineno-74-18></a><a href=#__codelineno-74-18><span class=linenos data-linenos="18 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>tmp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>str</span><span class=p>;</span>
<a id=__codelineno-74-19 name=__codelineno-74-19></a><a href=#__codelineno-74-19><span class=linenos data-linenos="19 "></span></a><span class=w>        </span><span class=n>std</span><span class=o>::</span><span class=n>transform</span><span class=p>(</span><span class=n>tmp</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span><span class=w> </span><span class=n>tmp</span><span class=p>.</span><span class=n>end</span><span class=p>(),</span><span class=w> </span><span class=n>tmp</span><span class=p>.</span><span class=n>begin</span><span class=p>(),</span>
<a id=__codelineno-74-20 name=__codelineno-74-20></a><a href=#__codelineno-74-20><span class=linenos data-linenos="20 "></span></a><span class=w>               </span><span class=p>[](</span><span class=kt>unsigned</span><span class=w> </span><span class=kt>char</span><span class=w> </span><span class=n>c</span><span class=p>){</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>toupper</span><span class=p>(</span><span class=n>c</span><span class=p>);</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-74-21 name=__codelineno-74-21></a><a href=#__codelineno-74-21><span class=linenos data-linenos="21 "></span></a><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>tmp</span><span class=p>;</span>
<a id=__codelineno-74-22 name=__codelineno-74-22></a><a href=#__codelineno-74-22><span class=linenos data-linenos="22 "></span></a><span class=w>    </span><span class=p>};</span>
<a id=__codelineno-74-23 name=__codelineno-74-23></a><a href=#__codelineno-74-23><span class=linenos data-linenos="23 "></span></a>
<a id=__codelineno-74-24 name=__codelineno-74-24></a><a href=#__codelineno-74-24><span class=linenos data-linenos="24 "></span></a><span class=w>    </span><span class=n>vecFilters</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>removeSpacesCnt</span><span class=p>);</span>
<a id=__codelineno-74-25 name=__codelineno-74-25></a><a href=#__codelineno-74-25><span class=linenos data-linenos="25 "></span></a><span class=w>    </span><span class=n>vecFilters</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>([](</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; Amazing&quot;</span><span class=p>;</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-74-26 name=__codelineno-74-26></a><a href=#__codelineno-74-26><span class=linenos data-linenos="26 "></span></a><span class=w>    </span><span class=n>vecFilters</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>([](</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; Modern&quot;</span><span class=p>;</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-74-27 name=__codelineno-74-27></a><a href=#__codelineno-74-27><span class=linenos data-linenos="27 "></span></a><span class=w>    </span><span class=n>vecFilters</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>([](</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; C++&quot;</span><span class=p>;</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-74-28 name=__codelineno-74-28></a><a href=#__codelineno-74-28><span class=linenos data-linenos="28 "></span></a><span class=w>    </span><span class=n>vecFilters</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>([](</span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=o>&amp;</span><span class=w> </span><span class=n>x</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w> </span><span class=k>return</span><span class=w> </span><span class=n>x</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&quot; World!&quot;</span><span class=p>;</span><span class=w> </span><span class=p>});</span>
<a id=__codelineno-74-29 name=__codelineno-74-29></a><a href=#__codelineno-74-29><span class=linenos data-linenos="29 "></span></a><span class=w>    </span><span class=n>vecFilters</span><span class=p>.</span><span class=n>emplace_back</span><span class=p>(</span><span class=n>makeUpperCase</span><span class=p>);</span>
<a id=__codelineno-74-30 name=__codelineno-74-30></a><a href=#__codelineno-74-30><span class=linenos data-linenos="30 "></span></a>
<a id=__codelineno-74-31 name=__codelineno-74-31></a><a href=#__codelineno-74-31><span class=linenos data-linenos="31 "></span></a><span class=w>    </span><span class=k>const</span><span class=w> </span><span class=n>std</span><span class=o>::</span><span class=n>string</span><span class=w> </span><span class=n>str</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&quot;   H e l l o     &quot;</span><span class=p>;</span>
<a id=__codelineno-74-32 name=__codelineno-74-32></a><a href=#__codelineno-74-32><span class=linenos data-linenos="32 "></span></a><span class=w>    </span><span class=k>auto</span><span class=w> </span><span class=n>temp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>str</span><span class=p>;</span>
<a id=__codelineno-74-33 name=__codelineno-74-33></a><a href=#__codelineno-74-33><span class=linenos data-linenos="33 "></span></a><span class=w>    </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=k>const</span><span class=w> </span><span class=k>auto</span><span class=w> </span><span class=o>&amp;</span><span class=n>entryFunc</span><span class=w> </span><span class=o>:</span><span class=w> </span><span class=n>vecFilters</span><span class=p>)</span>
<a id=__codelineno-74-34 name=__codelineno-74-34></a><a href=#__codelineno-74-34><span class=linenos data-linenos="34 "></span></a><span class=w>        </span><span class=n>temp</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>entryFunc</span><span class=p>(</span><span class=n>temp</span><span class=p>);</span>
<a id=__codelineno-74-35 name=__codelineno-74-35></a><a href=#__codelineno-74-35><span class=linenos data-linenos="35 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>temp</span><span class=p>;</span>
<a id=__codelineno-74-36 name=__codelineno-74-36></a><a href=#__codelineno-74-36><span class=linenos data-linenos="36 "></span></a>
<a id=__codelineno-74-37 name=__codelineno-74-37></a><a href=#__codelineno-74-37><span class=linenos data-linenos="37 "></span></a><span class=w>    </span><span class=n>std</span><span class=o>::</span><span class=n>cout</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=s>&quot;</span><span class=se>\n</span><span class=s>removed spaces: &quot;</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=n>removedSpaceCounter</span><span class=w> </span><span class=o>&lt;&lt;</span><span class=w> </span><span class=sc>&#39;\n&#39;</span><span class=p>;</span>
<a id=__codelineno-74-38 name=__codelineno-74-38></a><a href=#__codelineno-74-38><span class=linenos data-linenos="38 "></span></a><span class=p>}</span>
</code></pre></div> <p>输出：</p> <div class=highlight><pre><span></span><code><a id=__codelineno-75-1 name=__codelineno-75-1></a><a href=#__codelineno-75-1><span class=linenos data-linenos="1 "></span></a>HELLO AMAZING MODERN C++ WORLD!
<a id=__codelineno-75-2 name=__codelineno-75-2></a><a href=#__codelineno-75-2><span class=linenos data-linenos="2 "></span></a>removed spaces: 12
</code></pre></div> <p>这次我们将 <code>std::function&lt;std::string(const std::string&amp;)&gt;</code> 存储在容器中。</p> <p>这允许我们使用任何类型的函数对象，包括带有捕获变量的 Lambda 表达式。</p> <p>其中一个 lambda <code>removeSpacesCnt</code> 捕获一个变量，该变量用于存储有关从输入字符串中删除的空格的信息。</p> <h2 id=10-总结>10. 总结<a class=headerlink href=#10-总结 title="Permanent link"></a></h2> <p>在本章中，您学习了如何创建和使用 Lambda 表达式。我描述了 Lambda 的语法、捕获子句、类型，并且我们涵盖了许多示例和用例。</p> <p>我们甚至更进一步，我向您展示了从 Lambda 派生或将其存储在容器中的模式。</p> <p>但这还不是全部！</p> <p>Lambda 表达式成为现代 C++ 的重要组成部分。</p> <p>随着应用场景越来越多，开发人员也看到了改进此功能的可能性。</p> <p>这就是为什么您现在可以转到下一章并查看 ISO 委员会在 C++14 中添加的重要更新的原因。</p> <hr> <div class=md-source-file> <small> 最后更新: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">March 22, 2022</span> <br> 创建日期: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date">December 6, 2021</span> </small> </div> </article> </div> </div> <a href=# class="md-top md-icon" data-md-component=top data-md-state=hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg> 回到页面顶部 </a> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=页脚> <a href=../Chapter1/ class="md-footer__link md-footer__link--prev" aria-label="上一页: Lambda in C++98/03" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 上一页 </span> Lambda in C++98/03 </div> </div> </a> <a href=../Chapter3/ class="md-footer__link md-footer__link--next" aria-label="下一页: Lambda in C++14" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> 下一页 </span> Lambda in C++14 </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2022 <a href=https://github.com/nolongerwait target=_blank rel="noopener noreferrer">nolongerwait</a> </div> </div> <div class=md-social> <a href=https://github.com/nolongerwait/cpp_lambda_story_chinese_edition target=_blank rel=noopener title=github.com class=md-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 496 512"><!-- Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg> </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["header.autohide", "navigation.tracking", "navigation.top", "search.highlight", "search.share", "search.suggest", "toc.integrate", "content.code.annotate"], "search": "../assets/javascripts/workers/search.2a1c317c.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\s\\-\uff0c\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version.title": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script> <script src=../assets/javascripts/bundle.3a4b43e5.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script async src=https://umami.dup4.com/script.js data-website-id=c7e3ebdc-1ef6-405c-a6e0-48b49ce70067>
  </script> </body> </html>